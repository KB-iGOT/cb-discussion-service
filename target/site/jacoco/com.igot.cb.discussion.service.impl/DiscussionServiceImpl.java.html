<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DiscussionServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cb-discussion-service</a> &gt; <a href="index.source.html" class="el_package">com.igot.cb.discussion.service.impl</a> &gt; <span class="el_source">DiscussionServiceImpl.java</span></div><h1>DiscussionServiceImpl.java</h1><pre class="source lang-java linenums">package com.igot.cb.discussion.service.impl;

import com.auth0.jwt.JWT;
import com.auth0.jwt.algorithms.Algorithm;
import com.datastax.oss.driver.api.core.uuid.Uuids;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.igot.cb.authentication.util.AccessTokenValidator;
import com.igot.cb.discussion.entity.CommunityEntity;
import com.igot.cb.discussion.entity.DiscussionAnswerPostReplyEntity;
import com.igot.cb.discussion.entity.DiscussionEntity;
import com.igot.cb.discussion.repository.CommunityEngagementRepository;
import com.igot.cb.discussion.repository.DiscussionAnswerPostReplyRepository;
import com.igot.cb.discussion.repository.DiscussionRepository;
import com.igot.cb.discussion.service.DiscussionService;
import com.igot.cb.metrics.service.ApiMetricsTracker;
import com.igot.cb.notificationUtill.HelperMethodService;
import com.igot.cb.notificationUtill.NotificationTriggerService;
import com.igot.cb.pores.cache.CacheService;
import com.igot.cb.pores.elasticsearch.dto.SearchCriteria;
import com.igot.cb.pores.elasticsearch.dto.SearchResult;
import com.igot.cb.pores.elasticsearch.service.EsUtilService;
import com.igot.cb.pores.util.*;
import com.igot.cb.producer.Producer;
import com.igot.cb.profanity.IProfanityCheckService;
import com.igot.cb.transactional.cassandrautils.CassandraOperation;
import com.igot.cb.transactional.service.RequestHandlerServiceImpl;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.collections4.MapUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import org.sunbird.cloud.storage.BaseStorageService;
import org.sunbird.cloud.storage.factory.StorageConfig;
import org.sunbird.cloud.storage.factory.StorageServiceFactory;
import scala.Option;

import javax.annotation.PostConstruct;
import java.io.File;
import java.io.FileOutputStream;
import java.time.Instant;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.sql.Timestamp;
import java.util.*;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;
import java.util.stream.StreamSupport;

import static com.igot.cb.pores.util.Constants.*;

@Service
<span class="fc" id="L63">@Slf4j</span>
<span class="fc" id="L64">public class DiscussionServiceImpl implements DiscussionService {</span>
<span class="fc" id="L65">    private BaseStorageService storageService = null;</span>

    @Autowired
    private PayloadValidation payloadValidation;
    @Autowired
    private DiscussionRepository discussionRepository;
    @Autowired
    private CacheService cacheService;
    @Autowired
    private EsUtilService esUtilService;
    @Autowired
    private CbServerProperties cbServerProperties;
    @Autowired
    @Qualifier(Constants.SEARCH_RESULT_REDIS_TEMPLATE)
    private RedisTemplate&lt;String, SearchResult&gt; redisTemplate;
    @Autowired
    private ObjectMapper objectMapper;
    @Autowired
    private CassandraOperation cassandraOperation;
    @Autowired
    private AccessTokenValidator accessTokenValidator;
    @Autowired
    private CommunityEngagementRepository communityEngagementRepository;
    @Autowired
    private Producer producer;
    @Autowired
    private DiscussionAnswerPostReplyRepository discussionAnswerPostReplyRepository;
    @Autowired
    private NotificationTriggerService notificationTriggerService;
    @Autowired
    private HelperMethodService helperMethodService;

    @Autowired
    private RequestHandlerServiceImpl requestHandlerService;

    @Autowired
    private IProfanityCheckService profanityCheckService;

    @PostConstruct
    public void init() {
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (storageService == null) {</span>
<span class="nc" id="L106">            storageService = StorageServiceFactory.getStorageService(new StorageConfig(cbServerProperties.getCloudStorageTypeName(), cbServerProperties.getCloudStorageKey(), cbServerProperties.getCloudStorageSecret().replace(&quot;\\n&quot;, &quot;\n&quot;), Option.apply(cbServerProperties.getCloudStorageEndpoint()), Option.empty()));</span>
        }
<span class="fc" id="L108">    }</span>

    /**
     * Creates a new discussion based on the provided discussion details.
     *
     * @param discussionDetails The details of the discussion to be created.
     * @return A CustomResponse object containing the result of the operation.
     */
    @Override
    public ApiResponse createDiscussion(JsonNode discussionDetails, String token) {
<span class="fc" id="L118">        log.info(&quot;DiscussionService::createDiscussion:creating discussion&quot;);</span>
<span class="fc" id="L119">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;discussion.create&quot;);</span>
<span class="fc" id="L120">        payloadValidation.validatePayload(Constants.DISCUSSION_VALIDATION_SCHEMA, discussionDetails);</span>
<span class="fc" id="L121">        String userId = accessTokenValidator.verifyUserToken(token);</span>
<span class="pc bpc" id="L122" title="1 of 4 branches missed.">        if (StringUtils.isBlank(userId) || userId.equals(Constants.UNAUTHORIZED)) {</span>
<span class="fc" id="L123">            response.getParams().setErrMsg(Constants.INVALID_AUTH_TOKEN);</span>
<span class="fc" id="L124">            response.setResponseCode(HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L125">            return response;</span>
        }
<span class="fc bfc" id="L127" title="All 2 branches covered.">        if (!validateCommunityId(discussionDetails.get(Constants.COMMUNITY_ID).asText())) {</span>
<span class="fc" id="L128">            response.getParams().setErrMsg(Constants.INVALID_COMMUNITY_ID);</span>
<span class="fc" id="L129">            response.setResponseCode(HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L130">            return response;</span>
        }
<span class="fc" id="L132">        updateMetricsApiCall(Constants.DISCUSSION_CREATE);</span>
        try {
<span class="fc" id="L134">            JsonNode mentionedUsersNode = discussionDetails.get(MENTIONED_USERS);</span>
<span class="fc" id="L135">            List&lt;String&gt; userIdList = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L136" title="5 of 6 branches missed.">            if (mentionedUsersNode != null &amp;&amp; mentionedUsersNode.isArray() &amp;&amp; mentionedUsersNode.size() &gt; 0) {</span>
<span class="nc" id="L137">                Map&lt;String, JsonNode&gt; uniqueUserMap = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L138">                mentionedUsersNode.forEach(node -&gt; {</span>
<span class="nc" id="L139">                    String userid = node.path(USER_ID_RQST).asText(null);</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">                    if (StringUtils.isNotBlank(userid) &amp;&amp; !uniqueUserMap.containsKey(userid)) {</span>
<span class="nc" id="L141">                        uniqueUserMap.put(userid, node);</span>
                    }
<span class="nc" id="L143">                });</span>
<span class="nc" id="L144">                ArrayNode cleanArray = objectMapper.createArrayNode();</span>
<span class="nc" id="L145">                uniqueUserMap.values().forEach(cleanArray::add);</span>
<span class="nc" id="L146">                ((ObjectNode) discussionDetails).set(MENTIONED_USERS, cleanArray);</span>
<span class="nc" id="L147">                userIdList.addAll(uniqueUserMap.keySet());</span>
            }
<span class="fc" id="L149">            ObjectNode discussionDetailsNode = (ObjectNode) discussionDetails;</span>
<span class="fc" id="L150">            Map&lt;String, Object&gt; propertyMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L151">            propertyMap.put(Constants.USERID, userId);</span>
<span class="fc" id="L152">            propertyMap.put(Constants.COMMUNITY_ID, discussionDetailsNode.get(Constants.COMMUNITY_ID).asText());</span>
<span class="fc" id="L153">            List&lt;Map&lt;String, Object&gt;&gt; communityDetails = cassandraOperation.getRecordsByPropertiesWithoutFiltering(Constants.KEYSPACE_SUNBIRD, Constants.USER_COMMUNITY, propertyMap, Arrays.asList(Constants.STATUS), null);</span>
<span class="pc bpc" id="L154" title="1 of 4 branches missed.">            if (communityDetails.isEmpty() || !(boolean) communityDetails.get(0).get(Constants.STATUS)) {</span>
<span class="fc" id="L155">                DiscussionServiceUtil.createErrorResponse(response, Constants.USER_NOT_PART_OF_COMMUNITY, HttpStatus.BAD_REQUEST, Constants.FAILED);</span>
<span class="fc" id="L156">                return response;</span>
            }
<span class="fc" id="L158">            discussionDetailsNode.put(Constants.CREATED_BY, userId);</span>
<span class="fc" id="L159">            discussionDetailsNode.put(Constants.UP_VOTE_COUNT, 0L);</span>
<span class="fc" id="L160">            discussionDetailsNode.put(Constants.STATUS, Constants.ACTIVE);</span>

<span class="fc" id="L162">            DiscussionEntity jsonNodeEntity = new DiscussionEntity();</span>
<span class="fc" id="L163">            Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span>

<span class="fc" id="L165">            UUID id = Uuids.timeBased();</span>
<span class="fc" id="L166">            discussionDetailsNode.put(Constants.DISCUSSION_ID, String.valueOf(id));</span>
<span class="fc" id="L167">            jsonNodeEntity.setDiscussionId(String.valueOf(id));</span>
<span class="fc" id="L168">            jsonNodeEntity.setCreatedOn(currentTime);</span>
<span class="fc" id="L169">            discussionDetailsNode.put(Constants.CREATED_ON, getFormattedCurrentTime(currentTime));</span>
<span class="fc" id="L170">            discussionDetailsNode.put(Constants.UPDATED_ON, getFormattedCurrentTime(currentTime));</span>
<span class="fc" id="L171">            jsonNodeEntity.setUpdatedOn(currentTime);</span>
<span class="fc" id="L172">            jsonNodeEntity.setIsActive(true);</span>
<span class="fc" id="L173">            discussionDetailsNode.put(Constants.IS_ACTIVE, true);</span>
<span class="fc" id="L174">            jsonNodeEntity.setData(discussionDetailsNode);</span>
<span class="fc" id="L175">            jsonNodeEntity.setIsProfane(false);</span>
<span class="fc" id="L176">            long postgresTime = System.currentTimeMillis();</span>
<span class="fc" id="L177">            DiscussionEntity saveJsonEntity = discussionRepository.save(jsonNodeEntity);</span>
<span class="fc" id="L178">            updateMetricsDbOperation(Constants.DISCUSSION_CREATE, Constants.POSTGRES, Constants.INSERT, postgresTime);</span>
<span class="fc" id="L179">            ObjectNode jsonNode = objectMapper.createObjectNode();</span>
<span class="fc" id="L180">            jsonNode.setAll(discussionDetailsNode);</span>
<span class="fc" id="L181">            Map&lt;String, Object&gt; discussionPostDetailsMap = objectMapper.convertValue(discussionDetailsNode, Map.class);</span>
<span class="nc" id="L182">            discussionPostDetailsMap.put(IS_PROFANE,false);</span>
<span class="nc" id="L183">            response.setResponseCode(HttpStatus.CREATED);</span>
<span class="nc" id="L184">            response.getParams().setStatus(Constants.SUCCESS);</span>
<span class="nc" id="L185">            response.setResult(discussionPostDetailsMap);</span>
<span class="nc" id="L186">            esUtilService.addDocument(cbServerProperties.getDiscussionEntity(), saveJsonEntity.getDiscussionId(), discussionPostDetailsMap, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="nc" id="L187">            cacheService.putCache(Constants.DISCUSSION_CACHE_PREFIX + saveJsonEntity.getDiscussionId(), jsonNode);</span>
<span class="nc" id="L188">            deleteCacheByCommunity(Constants.DISCUSSION_CACHE_PREFIX + discussionDetails.get(Constants.COMMUNITY_ID).asText());</span>
<span class="nc" id="L189">            deleteCacheByCommunity(Constants.DISCUSSION_POSTS_BY_USER + discussionDetails.get(Constants.COMMUNITY_ID).asText() + Constants.UNDER_SCORE + userId);</span>
<span class="nc" id="L190">            updateCacheForFirstFivePages(discussionDetails.get(Constants.COMMUNITY_ID).asText(), false);</span>
<span class="nc" id="L191">            updateCacheForGlobalFeed(userId);</span>
<span class="nc" id="L192">            log.info(&quot;Updated cache for global feed&quot;);</span>
<span class="nc" id="L193">            Map&lt;String, String&gt; communityObject = new HashMap&lt;&gt;();</span>
<span class="nc" id="L194">            communityObject.put(Constants.COMMUNITY_ID, discussionDetails.get(Constants.COMMUNITY_ID).asText());</span>
<span class="nc" id="L195">            communityObject.put(Constants.STATUS, Constants.INCREMENT);</span>
<span class="nc" id="L196">            communityObject.put(Constants.TYPE, Constants.POST);</span>
<span class="nc" id="L197">            producer.push(cbServerProperties.getCommunityPostCount(), communityObject);</span>
<span class="nc" id="L198">            Map&lt;String, String&gt; userPostCount = new HashMap&lt;&gt;();</span>
<span class="nc" id="L199">            userPostCount.put(Constants.USERID, userId);</span>
<span class="nc" id="L200">            userPostCount.put(Constants.STATUS, Constants.INCREMENT);</span>
<span class="nc" id="L201">            producer.push(cbServerProperties.getKafkaUserPostCount(), userPostCount);</span>
            try {
<span class="nc" id="L203">                String createdBy = discussionDetailsNode.get(Constants.CREATED_BY).asText();</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                if (CollectionUtils.isNotEmpty(userIdList)) {</span>
<span class="nc" id="L205">                    List&lt;String&gt; filteredUserIdList = userIdList.stream()</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">                            .filter(uniqueId -&gt; !uniqueId.equals(createdBy)).toList();</span>

<span class="nc bnc" id="L208" title="All 2 branches missed.">                    if (CollectionUtils.isNotEmpty(filteredUserIdList)) {</span>
<span class="nc" id="L209">                        Map&lt;String, Object&gt; notificationData = Map.of(</span>
<span class="nc" id="L210">                                Constants.COMMUNITY_ID, discussionDetails.get(Constants.COMMUNITY_ID).asText(),</span>
<span class="nc" id="L211">                                Constants.DISCUSSION_ID, discussionDetails.get(Constants.DISCUSSION_ID).asText()</span>
                        );
<span class="nc" id="L213">                        String firstName = helperMethodService.fetchUserFirstName(userId);</span>
<span class="nc" id="L214">                        notificationTriggerService.triggerNotification(TAGGED_POST, ENGAGEMENT, filteredUserIdList, TITLE, firstName, notificationData);</span>
                    }
                }
<span class="nc" id="L217">            } catch (Exception e) {</span>
<span class="nc" id="L218">                log.error(&quot;Error while triggering notification&quot;, e);</span>
<span class="nc" id="L219">            }</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (discussionDetailsNode.hasNonNull(Constants.LANGUAGE)) {</span>
<span class="nc" id="L221">                profanityCheckService.processProfanityCheck(String.valueOf(id), discussionDetailsNode);</span>
            }
<span class="fc" id="L223">        } catch (Exception e) {</span>
<span class="fc" id="L224">            log.error(&quot;Failed to create discussion: {}&quot;, e.getMessage(), e);</span>
<span class="fc" id="L225">            DiscussionServiceUtil.createErrorResponse(response, Constants.FAILED_TO_CREATE_DISCUSSION, HttpStatus.INTERNAL_SERVER_ERROR, Constants.FAILED);</span>
<span class="fc" id="L226">            return response;</span>
<span class="nc" id="L227">        }</span>
<span class="nc" id="L228">        return response;</span>
    }

    private void updateCacheForGlobalFeed(String userId) {
        try {
<span class="fc" id="L233">            ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L234">            SearchCriteria searchCriteria = objectMapper.readValue(cbServerProperties.getFilterCriteriaForGlobalFeed(), SearchCriteria.class);</span>
<span class="nc" id="L235">            getGlobalFeedUsingUserId(searchCriteria, userId, true);</span>
<span class="fc" id="L236">        } catch (Exception e) {</span>
<span class="fc" id="L237">            log.error(&quot;Error occured while updating the cache for globalFeed&quot;, e);</span>
<span class="fc" id="L238">            throw new RuntimeException(&quot;Error parsing filter criteria JSON&quot;, e);</span>
<span class="nc" id="L239">        }</span>
<span class="nc" id="L240">    }</span>

    /**
     * Returns the discussion with the given id.
     *
     * @param discussionId The id of the discussion to retrieve
     * @return A CustomResponse containing the discussion's details
     */
    @Override
    public ApiResponse readDiscussion(String discussionId) {
<span class="fc" id="L250">        log.info(&quot;reading discussion details&quot;);</span>
<span class="fc" id="L251">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;discussion.read&quot;);</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">        if (StringUtils.isEmpty(discussionId)) {</span>
<span class="fc" id="L253">            log.error(&quot;discussion not found&quot;);</span>
<span class="fc" id="L254">            DiscussionServiceUtil.createErrorResponse(response, Constants.ID_NOT_FOUND, HttpStatus.BAD_REQUEST, Constants.FAILED);</span>
<span class="fc" id="L255">            return response;</span>
        }
        try {
<span class="fc" id="L258">            updateMetricsApiCall(Constants.DISCUSSION_READ);</span>
<span class="fc" id="L259">            long redisTime = System.currentTimeMillis();</span>
<span class="fc" id="L260">            String cachedJson = cacheService.getCache(Constants.DISCUSSION_CACHE_PREFIX + discussionId);</span>
<span class="fc" id="L261">            updateMetricsDbOperation(Constants.DISCUSSION_READ, Constants.REDIS, Constants.READ, redisTime);</span>
<span class="fc bfc" id="L262" title="All 2 branches covered.">            if (StringUtils.isNotEmpty(cachedJson)) {</span>
<span class="fc" id="L263">                log.info(&quot;discussion Record coming from redis cache&quot;);</span>
<span class="fc" id="L264">                response.setMessage(Constants.SUCCESS);</span>
<span class="fc" id="L265">                response.setResponseCode(HttpStatus.OK);</span>
<span class="fc" id="L266">                response.setResult((Map&lt;String, Object&gt;) objectMapper.readValue(cachedJson, new TypeReference&lt;Object&gt;() {</span>
                }));
            } else {
<span class="fc" id="L269">                long postgresTime = System.currentTimeMillis();</span>
<span class="fc" id="L270">                Optional&lt;DiscussionEntity&gt; entityOptional = discussionRepository.findById(discussionId);</span>
<span class="fc" id="L271">                updateMetricsDbOperation(Constants.DISCUSSION_READ, Constants.POSTGRES, Constants.READ, postgresTime);</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">                if (entityOptional.isPresent()) {</span>
<span class="fc" id="L273">                    DiscussionEntity discussionEntity = entityOptional.get();</span>
<span class="fc" id="L274">                    cacheService.putCache(Constants.DISCUSSION_CACHE_PREFIX + discussionId, discussionEntity.getData());</span>
<span class="fc" id="L275">                    log.info(&quot;discussion Record coming from postgres db&quot;);</span>
<span class="fc" id="L276">                    response.setMessage(Constants.SUCCESS);</span>
<span class="fc" id="L277">                    response.setResponseCode(HttpStatus.OK);</span>
<span class="fc" id="L278">                    response.setResult((Map&lt;String, Object&gt;) objectMapper.convertValue(discussionEntity.getData(), new TypeReference&lt;Object&gt;() {</span>
                    }));
<span class="fc" id="L280">                    response.getResult().put(Constants.IS_ACTIVE, discussionEntity.getIsActive());</span>
<span class="fc" id="L281">                    response.getResult().put(Constants.CREATED_ON, discussionEntity.getCreatedOn());</span>
<span class="fc" id="L282">                } else {</span>
<span class="fc" id="L283">                    log.error(&quot;Invalid discussionId: {}&quot;, discussionId);</span>
<span class="fc" id="L284">                    DiscussionServiceUtil.createErrorResponse(response, Constants.INVALID_ID, HttpStatus.NOT_FOUND, Constants.FAILED);</span>
<span class="fc" id="L285">                    return response;</span>
                }
            }
<span class="fc" id="L288">        } catch (Exception e) {</span>
<span class="fc" id="L289">            log.error(&quot; JSON for discussionId {}: {}&quot;, discussionId, e.getMessage(), e);</span>
<span class="fc" id="L290">            DiscussionServiceUtil.createErrorResponse(response, &quot;Failed to read the discussion&quot;, HttpStatus.INTERNAL_SERVER_ERROR, Constants.FAILED);</span>
<span class="fc" id="L291">            return response;</span>
<span class="fc" id="L292">        }</span>
<span class="fc" id="L293">        return response;</span>
    }


    /**
     * Updates the discussion with the given id based on the provided update data.
     *
     * @param updateData The data to be used for the update operation.
     * @return A CustomResponse object containing the result of the operation.
     */
    @Override
    public ApiResponse updateDiscussion(JsonNode updateData, String token) {
<span class="fc" id="L305">        ApiMetricsTracker.enableTracking();</span>
<span class="fc" id="L306">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;update.Discussion&quot;);</span>
<span class="fc" id="L307">        payloadValidation.validatePayload(Constants.DISCUSSION_UPDATE_VALIDATION_SCHEMA, updateData);</span>
<span class="fc" id="L308">        String userId = accessTokenValidator.verifyUserToken(token);</span>
<span class="pc bpc" id="L309" title="1 of 4 branches missed.">        if (StringUtils.isBlank(userId) || Constants.UNAUTHORIZED.equals(userId)) {</span>
<span class="fc" id="L310">            response.getParams().setErrMsg(Constants.INVALID_AUTH_TOKEN);</span>
<span class="fc" id="L311">            response.setResponseCode(HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L312">            return response;</span>
        }
        try {
<span class="fc" id="L315">            updateMetricsApiCall(Constants.DISCUSSION_UPDATE);</span>
<span class="fc" id="L316">            String discussionId = updateData.get(Constants.DISCUSSION_ID).asText();</span>
<span class="fc" id="L317">            long postgresTime = System.currentTimeMillis();</span>
<span class="fc" id="L318">            Optional&lt;DiscussionEntity&gt; discussionEntity = discussionRepository.findById(discussionId);</span>
<span class="fc" id="L319">            updateMetricsDbOperation(Constants.DISCUSSION_UPDATE, Constants.POSTGRES, Constants.READ, postgresTime);</span>
<span class="fc bfc" id="L320" title="All 2 branches covered.">            if (!discussionEntity.isPresent()) {</span>
<span class="fc" id="L321">                DiscussionServiceUtil.createErrorResponse(response, &quot;Discussion not found&quot;, HttpStatus.NOT_FOUND, Constants.FAILED);</span>
<span class="fc" id="L322">                return response;</span>
            }
<span class="fc" id="L324">            DiscussionEntity discussionDbData = discussionEntity.get();</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">            if (!discussionDbData.getIsActive()) {</span>
<span class="fc" id="L326">                DiscussionServiceUtil.createErrorResponse(response, Constants.DISCUSSION_IS_NOT_ACTIVE, HttpStatus.BAD_REQUEST, Constants.FAILED);</span>
<span class="fc" id="L327">                return response;</span>
            }
<span class="fc" id="L329">            ObjectNode data = (ObjectNode) discussionDbData.getData();</span>
<span class="fc" id="L330">            ObjectNode updateDataNode = (ObjectNode) updateData;</span>

<span class="fc" id="L332">            Set&lt;String&gt; existingMentionedUserIds = new HashSet&lt;&gt;();</span>
<span class="fc" id="L333">            data.withArray(MENTIONED_USERS).forEach(userNode -&gt; {</span>
<span class="nc" id="L334">                String userid = userNode.path(USER_ID_RQST).asText(null);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">                if (StringUtils.isNotBlank(userid)) existingMentionedUserIds.add(userid);</span>
<span class="nc" id="L336">            });</span>
<span class="fc" id="L337">            Set&lt;String&gt; seenUserIdsInRequest = new HashSet&lt;&gt;();</span>
<span class="fc" id="L338">            List&lt;String&gt; newlyAddedUserIds = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L339">            ArrayNode uniqueMentionedUsers = objectMapper.createArrayNode();</span>
<span class="fc" id="L340">            JsonNode incomingMentionedUsers = updateData.path(MENTIONED_USERS);</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">            if (incomingMentionedUsers.isArray()) {</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">                for (JsonNode userNode : incomingMentionedUsers) {</span>
<span class="nc" id="L343">                    String userid = userNode.path(USER_ID_RQST).asText(null);</span>
<span class="nc bnc" id="L344" title="All 4 branches missed.">                    if (StringUtils.isNotBlank(userid) &amp;&amp; seenUserIdsInRequest.add(userid)) {</span>
<span class="nc" id="L345">                        uniqueMentionedUsers.add(userNode);</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">                        if (!existingMentionedUserIds.contains(userid)) {</span>
<span class="nc" id="L347">                            newlyAddedUserIds.add(userid);</span>
                        }
                    }
<span class="nc" id="L350">                }</span>
            }

<span class="fc" id="L353">            updateDataNode.set(MENTIONED_USERS, uniqueMentionedUsers);</span>


<span class="pc bpc" id="L356" title="1 of 4 branches missed.">            if (data.get(Constants.COMMUNITY_ID) != null &amp;&amp; !data.get(Constants.COMMUNITY_ID).asText().equals(updateDataNode.get(Constants.COMMUNITY_ID).asText())) {</span>
<span class="fc" id="L357">                DiscussionServiceUtil.createErrorResponse(response, Constants.COMMUNITY_ID_CANNOT_BE_UPDATED, HttpStatus.BAD_REQUEST, Constants.FAILED);</span>
<span class="fc" id="L358">                return response;</span>
            }
<span class="fc" id="L360">            String communityId = updateData.get(Constants.COMMUNITY_ID).asText();</span>
<span class="fc" id="L361">            updateDataNode.remove(Constants.COMMUNITY_ID);</span>
<span class="fc" id="L362">            updateDataNode.remove(Constants.DISCUSSION_ID);</span>
<span class="fc" id="L363">            data.setAll(updateDataNode);</span>

<span class="pc bpc" id="L365" title="3 of 4 branches missed.">            if (!updateData.has(Constants.IS_INITIAL_UPLOAD) || !updateData.get(Constants.IS_INITIAL_UPLOAD).asBoolean()) {</span>
<span class="fc" id="L366">                Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span>
<span class="fc" id="L367">                data.put(Constants.UPDATED_ON, getFormattedCurrentTime(currentTime));</span>
<span class="fc" id="L368">                discussionDbData.setUpdatedOn(currentTime);</span>
            }

<span class="fc" id="L371">            discussionDbData.setData(data);</span>
<span class="fc" id="L372">            discussionDbData.setIsProfane(false);</span>
<span class="fc" id="L373">            long postgresInsertTime = System.currentTimeMillis();</span>
<span class="fc" id="L374">            discussionRepository.save(discussionDbData);</span>
<span class="fc" id="L375">            updateMetricsDbOperation(Constants.DISCUSSION_CREATE, Constants.POSTGRES, Constants.UPDATE_KEY, postgresInsertTime);</span>
<span class="fc" id="L376">            ObjectNode jsonNode = objectMapper.createObjectNode();</span>
<span class="fc" id="L377">            jsonNode.setAll(data);</span>

<span class="fc" id="L379">            Map&lt;String, Object&gt; discussionPostDetailsMap = objectMapper.convertValue(jsonNode, Map.class);</span>
<span class="fc" id="L380">            discussionPostDetailsMap.put(IS_PROFANE,false);</span>
<span class="fc" id="L381">            esUtilService.updateDocument(cbServerProperties.getDiscussionEntity(), discussionDbData.getDiscussionId(), discussionPostDetailsMap, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="fc" id="L382">            cacheService.putCache(Constants.DISCUSSION_CACHE_PREFIX + discussionDbData.getDiscussionId(), jsonNode);</span>
<span class="fc" id="L383">            deleteCacheByCommunity(Constants.DISCUSSION_POSTS_BY_USER + data.get(Constants.COMMUNITY_ID).asText() + Constants.UNDER_SCORE + userId);</span>
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">            if (data.has(Constants.CATEGORY_TYPE)</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">                    &amp;&amp; data.get(Constants.CATEGORY_TYPE).isArray()</span>
<span class="nc" id="L386">                    &amp;&amp; StreamSupport.stream(data.get(Constants.CATEGORY_TYPE).spliterator(), false)</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">                    .anyMatch(node -&gt; Constants.DOCUMENT.equals(node.asText()))) {</span>
<span class="nc" id="L388">                deleteCacheByCommunity(Constants.DISCUSSION_DOCUMENT_POST + data.get(Constants.COMMUNITY_ID).asText());</span>
<span class="nc" id="L389">                updateCacheForFirstFivePages(communityId, true);</span>
            }
<span class="fc" id="L391">            Map&lt;String, Object&gt; responseMap = objectMapper.convertValue(discussionDbData, new TypeReference&lt;Map&lt;String, Object&gt;&gt;() {</span>
            });
<span class="pc bpc" id="L393" title="1 of 2 branches missed.">            if (MapUtils.isNotEmpty(responseMap)) {</span>
<span class="nc" id="L394">                responseMap.remove(IS_PROFANE);</span>
<span class="nc" id="L395">                responseMap.remove(Constants.PROFANITY_RESPONSE);</span>
            }
<span class="fc" id="L397">            response.setResponseCode(HttpStatus.OK);</span>
<span class="fc" id="L398">            response.setResult(responseMap);</span>
<span class="fc" id="L399">            response.getParams().setStatus(Constants.SUCCESS);</span>
<span class="fc" id="L400">            deleteCacheByCommunity(Constants.DISCUSSION_CACHE_PREFIX + communityId);</span>
<span class="fc" id="L401">            updateCacheForFirstFivePages(communityId, false);</span>
<span class="nc" id="L402">            updateCacheForGlobalFeed(userId);</span>
<span class="nc" id="L403">            log.info(&quot;Updated cache for global feed&quot;);</span>
            try {
<span class="nc" id="L405">                String discussionOwner = discussionDbData.getData().get(Constants.CREATED_BY).asText();</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">                if (CollectionUtils.isNotEmpty(newlyAddedUserIds)) {</span>
<span class="nc" id="L407">                    List&lt;String&gt; filteredUserIds = newlyAddedUserIds.stream()</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">                            .filter(id -&gt; !id.equals(discussionOwner))</span>
<span class="nc" id="L409">                            .toList();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                    if (CollectionUtils.isNotEmpty(filteredUserIds)) {</span>
<span class="nc" id="L411">                        Map&lt;String, Object&gt; notificationData = Map.of(</span>
<span class="nc" id="L412">                                Constants.COMMUNITY_ID, discussionDbData.getData().get(Constants.COMMUNITY_ID).asText(),</span>
<span class="nc" id="L413">                                Constants.DISCUSSION_ID, discussionDbData.getDiscussionId()</span>
                        );
<span class="nc" id="L415">                        String firstName = helperMethodService.fetchUserFirstName(userId);</span>
<span class="nc" id="L416">                        notificationTriggerService.triggerNotification(TAGGED_POST, ENGAGEMENT, newlyAddedUserIds, TITLE, firstName, notificationData);</span>
                    }
                }
<span class="nc" id="L419">            } catch (Exception e) {</span>
<span class="nc" id="L420">                log.error(&quot;Error while triggering notification&quot;, e);</span>
<span class="nc" id="L421">            }</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">            if (updateData.hasNonNull(Constants.LANGUAGE)) {</span>
<span class="nc" id="L423">                ((ObjectNode) updateData).put(Constants.TYPE, data.get(Constants.TYPE).asText());</span>
<span class="nc" id="L424">                profanityCheckService.processProfanityCheck(discussionId, (ObjectNode) updateData);</span>
            }
<span class="fc" id="L426">        } catch (Exception e) {</span>
<span class="fc" id="L427">            log.error(&quot;Failed to update the discussion: &quot;, e);</span>
<span class="fc" id="L428">            DiscussionServiceUtil.createErrorResponse(response, &quot;Failed to update the discussion&quot;, HttpStatus.INTERNAL_SERVER_ERROR, Constants.FAILED);</span>
<span class="fc" id="L429">            return response;</span>
<span class="nc" id="L430">        }</span>
<span class="nc" id="L431">        return response;</span>
    }


    @Override
    public ApiResponse searchDiscussion(SearchCriteria searchCriteria, boolean isOverride) {
<span class="fc" id="L437">        log.info(&quot;DiscussionServiceImpl::searchDiscussion&quot;);</span>
<span class="fc" id="L438">        ApiMetricsTracker.enableTracking();</span>
<span class="fc" id="L439">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;search.discussion&quot;);</span>
<span class="fc" id="L440">        boolean isTrending = isTrendingPost(searchCriteria);</span>
<span class="fc" id="L441">        String cacheKey = generateRedisTokenKey(searchCriteria);</span>
<span class="fc" id="L442">        SearchResult searchResult = null;</span>
<span class="fc bfc" id="L443" title="All 2 branches covered.">        if (!isOverride) {</span>
<span class="fc" id="L444">            searchResult = redisTemplate.opsForValue().get(cacheKey);</span>
        }

<span class="fc bfc" id="L447" title="All 2 branches covered.">        if (searchResult != null) {</span>
<span class="fc" id="L448">            log.info(&quot;DiscussionServiceImpl::searchDiscussion:  search result fetched from redis&quot;);</span>
<span class="fc" id="L449">            response.getResult().put(Constants.SEARCH_RESULTS, searchResult);</span>
<span class="fc" id="L450">            DiscussionServiceUtil.createSuccessResponse(response);</span>
<span class="fc" id="L451">            return response;</span>
        }
<span class="fc" id="L453">        String searchString = searchCriteria.getSearchString();</span>
<span class="pc bpc" id="L454" title="1 of 6 branches missed.">        if (searchString != null &amp;&amp; !searchString.isEmpty() &amp;&amp; searchString.length() &lt; 3) {</span>
<span class="fc" id="L455">            DiscussionServiceUtil.createErrorResponse(response, Constants.MINIMUM_CHARACTERS_NEEDED, HttpStatus.BAD_REQUEST, Constants.FAILED_CONST);</span>
<span class="fc" id="L456">            return response;</span>
        }
        try {
<span class="fc" id="L459">            log.info(&quot;DiscussionServiceImpl::searchDiscussion:  search result fetched from es&quot;);</span>
<span class="fc bfc" id="L460" title="All 2 branches covered.">            if (MapUtils.isEmpty(searchCriteria.getFilterCriteriaMap())) {</span>
<span class="fc" id="L461">                searchCriteria.setFilterCriteriaMap(new HashMap&lt;&gt;());</span>
            }
<span class="fc" id="L463">            searchCriteria.getFilterCriteriaMap().put(Constants.IS_ACTIVE, true);</span>
<span class="fc" id="L464">            searchCriteria.getFilterCriteriaMap().put(IS_PROFANE, false);</span>

<span class="pc bpc" id="L466" title="1 of 2 branches missed.">            if (!searchCriteria.getFilterCriteriaMap().containsKey(Constants.STATUS) ||</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">                    (!searchCriteria.getFilterCriteriaMap().get(Constants.STATUS).equals(Collections.singletonList(Constants.REPORTED)) &amp;&amp;</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">                            !searchCriteria.getFilterCriteriaMap().get(Constants.STATUS).equals(Collections.singletonList(Constants.SUSPENDED)))) {</span>
<span class="fc" id="L469">                searchCriteria.getFilterCriteriaMap().put(Constants.STATUS, Arrays.asList(Constants.ACTIVE, Constants.REPORTED));</span>
            }

<span class="fc bfc" id="L472" title="All 2 branches covered.">            if (isTrending) {</span>
<span class="fc" id="L473">                List&lt;String&gt; communityIds = getTrendingPosts();</span>
<span class="fc" id="L474">                searchCriteria.getFilterCriteriaMap().put(Constants.COMMUNITY_ID, communityIds);</span>
            }
<span class="fc" id="L476">            searchResult = esUtilService.searchDocuments(cbServerProperties.getDiscussionEntity(), searchCriteria, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="fc bfc" id="L477" title="All 2 branches covered.">            if (CollectionUtils.isEmpty(searchResult.getData())) {</span>
<span class="fc" id="L478">                DiscussionServiceUtil.createErrorResponse(response, Constants.NO_DATA_FOUND, HttpStatus.OK, Constants.SUCCESS);</span>
<span class="fc" id="L479">                response.getResult().put(Constants.SEARCH_RESULTS, searchResult);</span>
<span class="fc" id="L480">                return response;</span>
            }
<span class="fc" id="L482">            List&lt;Map&lt;String, Object&gt;&gt; discussions = searchResult.getData();</span>

<span class="pc bpc" id="L484" title="1 of 4 branches missed.">            if (searchCriteria.getRequestedFields().contains(Constants.CREATED_BY) || searchCriteria.getRequestedFields().isEmpty()) {</span>
<span class="fc" id="L485">                boolean isAnswerPost = false;</span>
<span class="pc bpc" id="L486" title="1 of 4 branches missed.">                if (searchCriteria.getFilterCriteriaMap().containsKey(Constants.TYPE) &amp;&amp; Constants.ANSWER_POST.equals(searchCriteria.getFilterCriteriaMap().get(Constants.TYPE))) {</span>
<span class="nc" id="L487">                    isAnswerPost = true;</span>
                }
<span class="nc" id="L489">                fetchAndEnhanceDiscussions(discussions, isAnswerPost);</span>
            }
<span class="nc bnc" id="L491" title="All 2 branches missed.">            if (isTrending) {</span>
<span class="nc" id="L492">                enhanceCommunityData(discussions);</span>
            }
<span class="nc" id="L494">            searchResult.setData(discussions);</span>
<span class="nc" id="L495">            redisTemplate.opsForValue().set(cacheKey, searchResult, cbServerProperties.getSearchResultRedisTtl(), TimeUnit.SECONDS);</span>
<span class="nc" id="L496">            response.getResult().put(Constants.SEARCH_RESULTS, searchResult);</span>
<span class="nc" id="L497">            DiscussionServiceUtil.createSuccessResponse(response);</span>
<span class="nc" id="L498">            return response;</span>
<span class="fc" id="L499">        } catch (Exception e) {</span>
<span class="fc" id="L500">            log.error(&quot;error while searching discussion : {} .&quot;, e.getMessage(), e);</span>
<span class="fc" id="L501">            DiscussionServiceUtil.createErrorResponse(response, e.getMessage(), HttpStatus.INTERNAL_SERVER_ERROR, Constants.FAILED_CONST);</span>
<span class="fc" id="L502">            return response;</span>
        }
    }

    /**
     * Deletes the discussion with the given id.
     *
     * @param discussionId The id of the discussion to be deleted.
     * @return A CustomResponse object containing the result of the operation.
     */
    @Override
    public ApiResponse deleteDiscussion(String discussionId, String type, String token) {
<span class="fc" id="L514">        log.info(&quot;DiscussionServiceImpl::delete Discussion&quot;);</span>
<span class="fc" id="L515">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;delete.discussion&quot;);</span>
        try {
<span class="fc" id="L517">            String userId = accessTokenValidator.verifyUserToken(token);</span>
<span class="fc bfc" id="L518" title="All 2 branches covered.">            if (StringUtils.isBlank(userId)) {</span>
<span class="fc" id="L519">                response.getParams().setErrMsg(Constants.INVALID_AUTH_TOKEN);</span>
<span class="fc" id="L520">                response.setResponseCode(HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L521">                return response;</span>
            }

<span class="pc bpc" id="L524" title="1 of 2 branches missed.">            if (StringUtils.isNotEmpty(discussionId)) {</span>
<span class="fc" id="L525">                Optional&lt;DiscussionEntity&gt; entityOptional = discussionRepository.findById(discussionId);</span>
<span class="fc bfc" id="L526" title="All 2 branches covered.">                if (entityOptional.isPresent()) {</span>
<span class="fc" id="L527">                    DiscussionEntity jasonEntity = entityOptional.get();</span>
<span class="fc" id="L528">                    JsonNode data = jasonEntity.getData();</span>
<span class="fc bfc" id="L529" title="All 2 branches covered.">                    if (!type.equals(data.get(Constants.TYPE).asText())) {</span>
<span class="fc" id="L530">                        DiscussionServiceUtil.createErrorResponse(response, Constants.INVALID_TYPE + type, HttpStatus.BAD_REQUEST, Constants.FAILED);</span>
<span class="fc" id="L531">                        return response;</span>
                    }
<span class="fc" id="L533">                    Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span>
<span class="pc bpc" id="L534" title="1 of 2 branches missed.">                    if (jasonEntity.getIsActive()) {</span>
<span class="fc" id="L535">                        jasonEntity.setIsActive(false);</span>
<span class="fc" id="L536">                        jasonEntity.setUpdatedOn(currentTime);</span>
<span class="fc" id="L537">                        ((ObjectNode) data).put(Constants.IS_ACTIVE, false);</span>
<span class="fc" id="L538">                        ((ObjectNode) data).put(Constants.UPDATED_ON, String.valueOf(currentTime));</span>
<span class="fc" id="L539">                        jasonEntity.setData(data);</span>
<span class="fc" id="L540">                        jasonEntity.setDiscussionId(discussionId);</span>
<span class="fc" id="L541">                        jasonEntity.setUpdatedOn(currentTime);</span>
<span class="fc" id="L542">                        discussionRepository.save(jasonEntity);</span>
<span class="fc" id="L543">                        Map&lt;String, Object&gt; map = objectMapper.convertValue(data, Map.class);</span>
<span class="fc" id="L544">                        map.put(Constants.IS_ACTIVE, false);</span>
<span class="fc" id="L545">                        esUtilService.updateDocument(cbServerProperties.getDiscussionEntity(), discussionId, map, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="fc" id="L546">                        cacheService.putCache(Constants.DISCUSSION_CACHE_PREFIX + discussionId, data);</span>
<span class="fc" id="L547">                        log.info(&quot;Discussion details deleted successfully&quot;);</span>
<span class="fc" id="L548">                        response.setResponseCode(HttpStatus.OK);</span>
<span class="fc" id="L549">                        response.setMessage(Constants.DELETED_SUCCESSFULLY);</span>
<span class="fc" id="L550">                        response.getParams().setStatus(Constants.SUCCESS);</span>
<span class="fc" id="L551">                        Map&lt;String, String&gt; communityObject = new HashMap&lt;&gt;();</span>
<span class="fc" id="L552">                        communityObject.put(Constants.COMMUNITY_ID,</span>
<span class="fc" id="L553">                                (String) map.get(Constants.COMMUNITY_ID));</span>
<span class="fc" id="L554">                        communityObject.put(Constants.STATUS, Constants.DECREMENT);</span>
<span class="fc bfc" id="L555" title="All 2 branches covered.">                        if (Constants.QUESTION.equalsIgnoreCase(data.get(Constants.TYPE).asText())) {</span>
<span class="fc" id="L556">                            communityObject.put(Constants.TYPE, Constants.POST);</span>
                        } else {
<span class="fc" id="L558">                            communityObject.put(Constants.TYPE, Constants.ANSWER_POST);</span>
<span class="fc" id="L559">                            DiscussionEntity discussionEntity = discussionRepository.findById(</span>
<span class="fc" id="L560">                                    data.get(Constants.PARENT_DISCUSSION_ID).asText()).orElse(null);</span>
<span class="pc bpc" id="L561" title="1 of 2 branches missed.">                            if (discussionEntity != null) {</span>
<span class="nc" id="L562">                                updateAnswerPostToDiscussion(discussionEntity, discussionId,</span>
                                        Constants.DECREMENT);
                            }
<span class="fc" id="L565">                            redisTemplate.opsForValue().getAndDelete(</span>
<span class="fc" id="L566">                                    DiscussionServiceUtil.generateRedisJwtTokenKey(createSearchCriteriaWithDefaults(</span>
<span class="fc" id="L567">                                            data.get(Constants.PARENT_DISCUSSION_ID).asText(),</span>
<span class="fc" id="L568">                                            data.get(Constants.COMMUNITY_ID).asText(),</span>
                                            Constants.ANSWER_POST)));
                        }
<span class="fc" id="L571">                        deleteCacheByCommunity(Constants.DISCUSSION_CACHE_PREFIX + map.get(Constants.COMMUNITY_ID));</span>
<span class="fc" id="L572">                        updateCacheForFirstFivePages((String) map.get(Constants.COMMUNITY_ID), false);</span>
<span class="nc" id="L573">                        updateCacheForGlobalFeed(userId);</span>
<span class="nc" id="L574">                        log.info(&quot;Updated cache for global feed&quot;);</span>
<span class="nc" id="L575">                        producer.push(cbServerProperties.getCommunityPostCount(), communityObject);</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">                        if (Constants.QUESTION.equalsIgnoreCase(data.get(Constants.TYPE).asText())) {</span>
<span class="nc" id="L577">                            Map&lt;String, String&gt; userPostCount = new HashMap&lt;&gt;();</span>
<span class="nc" id="L578">                            userPostCount.put(Constants.USERID, userId);</span>
<span class="nc" id="L579">                            userPostCount.put(Constants.STATUS, Constants.DECREMENT);</span>
<span class="nc" id="L580">                            producer.push(cbServerProperties.getKafkaUserPostCount(), userPostCount);</span>
                        }
<span class="nc" id="L582">                        return response;</span>
                    } else {
<span class="nc" id="L584">                        log.info(&quot;Discussion is already inactive.&quot;);</span>
<span class="nc" id="L585">                        DiscussionServiceUtil.createErrorResponse(response, Constants.DISCUSSION_IS_INACTIVE, HttpStatus.ALREADY_REPORTED, Constants.SUCCESS);</span>
<span class="nc" id="L586">                        return response;</span>
                    }
                } else {
<span class="fc" id="L589">                    DiscussionServiceUtil.createErrorResponse(response, Constants.INVALID_ID, HttpStatus.BAD_REQUEST, Constants.NO_DATA_FOUND);</span>
<span class="fc" id="L590">                    return response;</span>
                }
            }
<span class="fc" id="L593">        } catch (Exception e) {</span>
<span class="fc" id="L594">            log.error(&quot;Error while deleting discussion with ID: {}. Exception: {}&quot;, discussionId, e.getMessage(), e);</span>
<span class="fc" id="L595">            DiscussionServiceUtil.createErrorResponse(response, Constants.FAILED_TO_DELETE_DISCUSSION, HttpStatus.INTERNAL_SERVER_ERROR, Constants.FAILED);</span>
<span class="fc" id="L596">            return response;</span>
<span class="nc" id="L597">        }</span>
<span class="nc" id="L598">        return response;</span>
    }

    private ApiResponse vote(String discussionId, String type, String token, String voteType) {
<span class="fc" id="L602">        log.info(&quot;DiscussionServiceImpl::vote - Type: {}&quot;, voteType);</span>
<span class="fc" id="L603">        ApiResponse response = ProjectUtil.createDefaultResponse(Constants.DISCUSSION_VOTE_API);</span>
        try {
<span class="fc" id="L605">            String userId = accessTokenValidator.verifyUserToken(token);</span>
<span class="pc bpc" id="L606" title="1 of 4 branches missed.">            if (StringUtils.isEmpty(userId) || Constants.UNAUTHORIZED.equals(userId)) {</span>
<span class="fc" id="L607">                DiscussionServiceUtil.createErrorResponse(response, Constants.INVALID_AUTH_TOKEN, HttpStatus.BAD_REQUEST, Constants.FAILED);</span>
<span class="fc" id="L608">                return response;</span>
            }

<span class="fc" id="L611">            boolean isAnswerReply = Constants.ANSWER_POST_REPLY.equals(type);</span>
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">            Object entityObject = isAnswerReply</span>
<span class="nc" id="L613">                    ? discussionAnswerPostReplyRepository.findById(discussionId).orElse(null)</span>
<span class="fc" id="L614">                    : discussionRepository.findById(discussionId).orElse(null);</span>

<span class="fc bfc" id="L616" title="All 2 branches covered.">            if (entityObject == null) {</span>
<span class="fc" id="L617">                DiscussionServiceUtil.createErrorResponse(response, Constants.DISCUSSION_NOT_FOUND, HttpStatus.BAD_REQUEST, Constants.FAILED);</span>
<span class="fc" id="L618">                return response;</span>
            }

            JsonNode dataNode;
            Boolean isActive;
<span class="pc bpc" id="L623" title="1 of 2 branches missed.">            if (isAnswerReply) {</span>
<span class="nc" id="L624">                DiscussionAnswerPostReplyEntity replyEntity = (DiscussionAnswerPostReplyEntity) entityObject;</span>
<span class="nc" id="L625">                dataNode = replyEntity.getData();</span>
<span class="nc" id="L626">                isActive = replyEntity.getIsActive();</span>
<span class="nc" id="L627">            } else {</span>
<span class="fc" id="L628">                DiscussionEntity discussionEntity = (DiscussionEntity) entityObject;</span>
<span class="fc" id="L629">                dataNode = discussionEntity.getData();</span>
<span class="fc" id="L630">                isActive = discussionEntity.getIsActive();</span>
            }

<span class="fc" id="L633">            HashMap&lt;String, Object&gt; discussionData = objectMapper.convertValue(dataNode, HashMap.class);</span>

<span class="fc bfc" id="L635" title="All 2 branches covered.">            if (!isActive) {</span>
<span class="fc" id="L636">                DiscussionServiceUtil.createErrorResponse(response, Constants.DISCUSSION_IS_INACTIVE, HttpStatus.BAD_REQUEST, Constants.FAILED);</span>
<span class="fc" id="L637">                return response;</span>
            }
<span class="fc bfc" id="L639" title="All 2 branches covered.">            if (!type.equals(discussionData.get(Constants.TYPE))) {</span>
<span class="fc" id="L640">                DiscussionServiceUtil.createErrorResponse(response, Constants.INVALID_TYPE + type, HttpStatus.BAD_REQUEST, Constants.FAILED);</span>
<span class="fc" id="L641">                return response;</span>
            }

<span class="fc" id="L644">            boolean currentVote = Constants.UP.equals(voteType);</span>

<span class="fc" id="L646">            Object upVoteCountObj = discussionData.get(Constants.UP_VOTE_COUNT);</span>
<span class="pc bpc" id="L647" title="1 of 2 branches missed.">            long existingUpVoteCount = (upVoteCountObj instanceof Number) ? ((Number) upVoteCountObj).longValue() : 0L;</span>

<span class="fc" id="L649">            Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L650">            properties.put(Constants.DISCUSSION_ID_KEY, discussionId);</span>
<span class="fc" id="L651">            properties.put(Constants.USERID, userId);</span>
<span class="fc" id="L652">            List&lt;Map&lt;String, Object&gt;&gt; existingResponseList = cassandraOperation.getRecordsByPropertiesWithoutFiltering(Constants.KEYSPACE_SUNBIRD, Constants.USER_POST_VOTES, properties, null, null);</span>

<span class="pc bpc" id="L654" title="1 of 2 branches missed.">            if (CollectionUtils.isEmpty(existingResponseList)) {</span>
<span class="pc bpc" id="L655" title="1 of 2 branches missed.">                if (currentVote) {</span>
<span class="fc" id="L656">                    Map&lt;String, Object&gt; propertyMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L657">                    propertyMap.put(Constants.USER_ID_RQST, userId);</span>
<span class="fc" id="L658">                    propertyMap.put(Constants.DISCUSSION_ID_KEY, discussionId);</span>
<span class="fc" id="L659">                    propertyMap.put(Constants.VOTE_TYPE, currentVote);</span>

<span class="fc" id="L661">                    ApiResponse result = (ApiResponse) cassandraOperation.insertRecord(Constants.KEYSPACE_SUNBIRD, Constants.USER_POST_VOTES, propertyMap);</span>
<span class="fc" id="L662">                    Map&lt;String, Object&gt; resultMap = result.getResult();</span>
<span class="pc bpc" id="L663" title="1 of 2 branches missed.">                    if (!resultMap.get(Constants.RESPONSE).equals(Constants.SUCCESS)) {</span>
<span class="nc" id="L664">                        response.setResponseCode(HttpStatus.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L665">                        response.setMessage(Constants.FAILED);</span>
<span class="nc" id="L666">                        return response;</span>
                    }
<span class="fc" id="L668">                    Map&lt;String, String&gt; communityObject = new HashMap&lt;&gt;();</span>
<span class="fc" id="L669">                    communityObject.put(Constants.COMMUNITY_ID, dataNode.get(Constants.COMMUNITY_ID).asText());</span>
<span class="fc" id="L670">                    communityObject.put(Constants.STATUS, Constants.INCREMENT);</span>
<span class="fc" id="L671">                    communityObject.put(Constants.DISCUSSION_ID, discussionId);</span>
<span class="fc" id="L672">                    producer.push(cbServerProperties.getCommunityLikeCount(), communityObject);</span>
<span class="fc" id="L673">                } else {</span>
<span class="nc" id="L674">                    DiscussionServiceUtil.createErrorResponse(response, Constants.USER_MUST_VOTE_FIRST, HttpStatus.BAD_REQUEST, Constants.FAILED);</span>
<span class="nc" id="L675">                    return response;</span>
                }
            } else {
<span class="nc" id="L678">                Map&lt;String, Object&gt; userVoteData = existingResponseList.get(0);</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">                if (userVoteData.get(Constants.VOTE_TYPE).equals(currentVote)) {</span>
<span class="nc" id="L680">                    DiscussionServiceUtil.createErrorResponse(response, String.format(Constants.USER_ALREADY_VOTED, voteType), HttpStatus.ALREADY_REPORTED, Constants.FAILED);</span>
<span class="nc" id="L681">                    return response;</span>
                }

<span class="nc" id="L684">                Map&lt;String, Object&gt; updateAttribute = new HashMap&lt;&gt;();</span>
<span class="nc" id="L685">                updateAttribute.put(Constants.VOTE_TYPE, currentVote);</span>
<span class="nc" id="L686">                Map&lt;String, Object&gt; compositeKeys = new HashMap&lt;&gt;();</span>
<span class="nc" id="L687">                compositeKeys.put(Constants.USER_ID_RQST, userId);</span>
<span class="nc" id="L688">                compositeKeys.put(Constants.DISCUSSION_ID_KEY, discussionId);</span>

<span class="nc" id="L690">                Map&lt;String, Object&gt; result = cassandraOperation.updateRecordByCompositeKey(Constants.KEYSPACE_SUNBIRD, Constants.USER_POST_VOTES, updateAttribute, compositeKeys);</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">                if (!result.get(Constants.RESPONSE).equals(Constants.SUCCESS)) {</span>
<span class="nc" id="L692">                    DiscussionServiceUtil.createErrorResponse(response, Constants.FAILED_TO_VOTE, HttpStatus.INTERNAL_SERVER_ERROR, Constants.FAILED);</span>
<span class="nc" id="L693">                    return response;</span>
                }

<span class="nc" id="L696">                Map&lt;String, String&gt; communityObject = new HashMap&lt;&gt;();</span>
<span class="nc" id="L697">                communityObject.put(Constants.COMMUNITY_ID, dataNode.get(Constants.COMMUNITY_ID).asText());</span>
<span class="nc" id="L698">                communityObject.put(Constants.DISCUSSION_ID, discussionId);</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">                communityObject.put(Constants.STATUS, Constants.UP.equals(voteType) ? Constants.INCREMENT : Constants.DECREMENT);</span>
<span class="nc" id="L700">                producer.push(cbServerProperties.getCommunityLikeCount(), communityObject);</span>
            }

<span class="pc bpc" id="L703" title="1 of 2 branches missed.">            discussionData.put(Constants.UP_VOTE_COUNT, currentVote ? existingUpVoteCount + 1 : existingUpVoteCount - 1);</span>

<span class="fc" id="L705">            JsonNode updatedData = objectMapper.valueToTree(discussionData);</span>
<span class="pc bpc" id="L706" title="1 of 2 branches missed.">            if (isAnswerReply) {</span>
<span class="nc" id="L707">                DiscussionAnswerPostReplyEntity replyEntity = (DiscussionAnswerPostReplyEntity) entityObject;</span>
<span class="nc" id="L708">                replyEntity.setData(updatedData);</span>
<span class="nc" id="L709">                discussionAnswerPostReplyRepository.save(replyEntity);</span>
<span class="nc" id="L710">            } else {</span>
<span class="fc" id="L711">                DiscussionEntity discussionEntity = (DiscussionEntity) entityObject;</span>
<span class="fc" id="L712">                discussionEntity.setData(updatedData);</span>
<span class="fc" id="L713">                discussionRepository.save(discussionEntity);</span>
            }

<span class="fc" id="L716">            esUtilService.updateDocument(cbServerProperties.getDiscussionEntity(), discussionId, discussionData, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="fc" id="L717">            cacheService.putCache(Constants.DISCUSSION_CACHE_PREFIX + discussionId, discussionData);</span>

<span class="pc bpc" id="L719" title="1 of 2 branches missed.">            if (!isAnswerReply) {</span>
<span class="fc" id="L720">                updateCacheForFirstFivePages(dataNode.get(Constants.COMMUNITY_ID).asText(), false);</span>
<span class="nc" id="L721">                updateCacheForGlobalFeed(userId);</span>
            }

            try {
<span class="nc" id="L725">                String createdBy = dataNode.get(Constants.CREATED_BY).asText();</span>

<span class="nc" id="L727">                Map&lt;String, Object&gt; data = Map.of(</span>
<span class="nc" id="L728">                        Constants.COMMUNITY_ID, dataNode.get(Constants.COMMUNITY_ID).asText(),</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">                        Constants.DISCUSSION_ID, type.equalsIgnoreCase(Constants.QUESTION) ? discussionId : discussionData.get(Constants.PARENT_DISCUSSION_ID)</span>
                );


<span class="nc" id="L733">                String firstName = helperMethodService.fetchUserFirstName(userId);</span>
<span class="nc" id="L734">                log.info(&quot;Notification trigger started&quot;);</span>
<span class="nc bnc" id="L735" title="All 4 branches missed.">                if (currentVote &amp;&amp; !userId.equals(createdBy)) {</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">                    if (type.equalsIgnoreCase(Constants.QUESTION)) {</span>
<span class="nc" id="L737">                        notificationTriggerService.triggerNotification(LIKED_POST, ENGAGEMENT, List.of(createdBy), TITLE, firstName, data);</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">                    } else if (type.equalsIgnoreCase(Constants.ANSWER_POST)) {</span>
<span class="nc" id="L739">                        notificationTriggerService.triggerNotification(POST_COMMENT, ENGAGEMENT, List.of(createdBy), TITLE, firstName, data);</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">                    } else if (type.equalsIgnoreCase(Constants.ANSWER_POST_REPLY)) {</span>
<span class="nc" id="L741">                        notificationTriggerService.triggerNotification(REPLIED_POST, ENGAGEMENT, List.of(createdBy), TITLE, firstName, data);</span>
                    }
                }
<span class="nc" id="L744">            } catch (Exception e) {</span>
<span class="nc" id="L745">                log.error(&quot;Error while triggering notification&quot;, e);</span>
<span class="nc" id="L746">            }</span>

<span class="nc bnc" id="L748" title="All 2 branches missed.">            if (Constants.ANSWER_POST.equals(type)) {</span>
<span class="nc" id="L749">                redisTemplate.opsForValue()</span>
<span class="nc" id="L750">                        .getAndDelete(DiscussionServiceUtil.generateRedisJwtTokenKey(createSearchCriteriaWithDefaults(</span>
<span class="nc" id="L751">                                (String) discussionData.get(Constants.PARENT_DISCUSSION_ID),</span>
<span class="nc" id="L752">                                (String) discussionData.get(Constants.COMMUNITY_ID),</span>
                                Constants.ANSWER_POST)));
            }
<span class="nc bnc" id="L755" title="All 2 branches missed.">            if (Constants.ANSWER_POST_REPLY.equals(type)) {</span>
<span class="nc" id="L756">                redisTemplate.opsForValue().getAndDelete(DiscussionServiceUtil.generateRedisJwtTokenKey(createDefaultSearchCriteria(</span>
<span class="nc" id="L757">                        (String) discussionData.get(Constants.PARENT_ANSWER_POST_ID),</span>
<span class="nc" id="L758">                        (String) discussionData.get(Constants.COMMUNITY_ID))));</span>
            }
<span class="nc" id="L760">            response.setResponseCode(HttpStatus.OK);</span>
<span class="nc" id="L761">            response.getParams().setStatus(Constants.SUCCESS);</span>
<span class="fc" id="L762">        } catch (Exception e) {</span>
<span class="fc" id="L763">            log.error(&quot;Error while processing vote: {}&quot;, e.getMessage(), e);</span>
<span class="fc" id="L764">            response.setResponseCode(HttpStatus.INTERNAL_SERVER_ERROR);</span>
<span class="fc" id="L765">            response.setMessage(Constants.FAILED);</span>
<span class="fc" id="L766">            response.getParams().setErrMsg(Constants.FAILED);</span>
<span class="fc" id="L767">            return response;</span>
<span class="nc" id="L768">        }</span>
<span class="nc" id="L769">        return response;</span>
    }

    public List&lt;Object&gt; fetchDataForKeys(List&lt;String&gt; keys, boolean isUserData) {
        // Fetch values for all keys from Redis
        List&lt;Object&gt; values;
<span class="pc bpc" id="L775" title="1 of 2 branches missed.">        if (isUserData) {</span>
<span class="fc" id="L776">            values = cacheService.hget(keys);</span>
        } else {
<span class="nc" id="L778">            values = cacheService.hgetMulti(keys);</span>
        }

        // Create a map of key-value pairs, converting stringified JSON objects to User objects
<span class="pc" id="L782">        return keys.stream()</span>
<span class="pc bnc" id="L783" title="All 2 branches missed.">                .filter(key -&gt; values.get(keys.indexOf(key)) != null) // Filter out null values</span>
<span class="fc" id="L784">                .map(key -&gt; {</span>
<span class="nc" id="L785">                    String stringifiedJson = (String) values.get(keys.indexOf(key)); // Cast the value to String</span>
                    try {
                        // Convert the stringified JSON to a User object using ObjectMapper
<span class="nc" id="L788">                        return objectMapper.readValue(stringifiedJson, Object.class); // You can map this to a specific User type if needed</span>
<span class="nc" id="L789">                    } catch (Exception e) {</span>
<span class="nc" id="L790">                        log.error(&quot;Failed to fetch user data from redis &quot;, e.getMessage(), e);</span>
<span class="nc" id="L791">                        return null; // Return null in case of error</span>
                    }
                })
<span class="nc" id="L794">                .collect(Collectors.toList());</span>
    }

    public List&lt;Object&gt; fetchUserFromPrimary(List&lt;String&gt; userIds) {
<span class="fc" id="L798">        log.info(&quot;DiscussionServiceImpl::fetchUserFromPrimary: Fetching user data from Cassandra&quot;);</span>
<span class="fc" id="L799">        List&lt;Object&gt; userList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L800">        Map&lt;String, Object&gt; propertyMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L801">        propertyMap.put(Constants.ID, userIds);</span>
<span class="fc" id="L802">        long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L803">        List&lt;Map&lt;String, Object&gt;&gt; userInfoList = cassandraOperation.getRecordsByPropertiesWithoutFiltering(</span>
                Constants.KEYSPACE_SUNBIRD, Constants.USER_TABLE, propertyMap,
<span class="fc" id="L805">                Arrays.asList(Constants.PROFILE_DETAILS, Constants.FIRST_NAME, Constants.ID), null);</span>
<span class="fc" id="L806">        updateMetricsDbOperation(Constants.DISCUSSION_SEARCH, Constants.CASSANDRA, Constants.READ, startTime);</span>
<span class="fc" id="L807">        userList = userInfoList.stream()</span>
<span class="fc" id="L808">                .map(userInfo -&gt; {</span>
<span class="fc" id="L809">                    Map&lt;String, Object&gt; userMap = new HashMap&lt;&gt;();</span>

                    // Extract user ID and user name
<span class="fc" id="L812">                    String userId = (String) userInfo.get(Constants.ID);</span>
<span class="fc" id="L813">                    String userName = (String) userInfo.get(Constants.FIRST_NAME);</span>

<span class="fc" id="L815">                    userMap.put(Constants.USER_ID_KEY, userId);</span>
<span class="fc" id="L816">                    userMap.put(Constants.FIRST_NAME_KEY, userName);</span>

                    // Process profile details if present
<span class="fc" id="L819">                    String profileDetails = (String) userInfo.get(Constants.PROFILE_DETAILS);</span>
<span class="fc bfc" id="L820" title="All 2 branches covered.">                    if (StringUtils.isNotBlank(profileDetails)) {</span>
                        try {
                            // Convert JSON profile details to a Map
<span class="fc" id="L823">                            Map&lt;String, Object&gt; profileDetailsMap = objectMapper.readValue(profileDetails,</span>
<span class="fc" id="L824">                                    new TypeReference&lt;HashMap&lt;String, Object&gt;&gt;() {</span>
                                    });

                            // Check for profile image and add to userMap if available
<span class="pc bpc" id="L828" title="1 of 2 branches missed.">                            if (MapUtils.isNotEmpty(profileDetailsMap)) {</span>
<span class="pc bpc" id="L829" title="2 of 4 branches missed.">                                if (profileDetailsMap.containsKey(Constants.PROFILE_IMG) &amp;&amp; StringUtils.isNotBlank((String) profileDetailsMap.get(Constants.PROFILE_IMG))) {</span>
<span class="fc" id="L830">                                    userMap.put(Constants.PROFILE_IMG_KEY, (String) profileDetailsMap.get(Constants.PROFILE_IMG));</span>
                                }
<span class="pc bpc" id="L832" title="1 of 4 branches missed.">                                if (profileDetailsMap.containsKey(Constants.DESIGNATION_KEY) &amp;&amp; StringUtils.isNotEmpty((String) profileDetailsMap.get(Constants.DESIGNATION_KEY))) {</span>

<span class="fc" id="L834">                                    userMap.put(Constants.DESIGNATION_KEY, (String) profileDetailsMap.get(Constants.PROFILE_IMG));</span>
                                }
<span class="pc bpc" id="L836" title="1 of 4 branches missed.">                                if (profileDetailsMap.containsKey(Constants.EMPLOYMENT_DETAILS) &amp;&amp; MapUtils.isNotEmpty(</span>
<span class="pc bpc" id="L837" title="2 of 4 branches missed.">                                        (Map&lt;?, ?&gt;) profileDetailsMap.get(Constants.EMPLOYMENT_DETAILS)) &amp;&amp; ((Map&lt;?, ?&gt;) profileDetailsMap.get(Constants.EMPLOYMENT_DETAILS)).containsKey(Constants.DEPARTMENT_KEY) &amp;&amp; StringUtils.isNotBlank(</span>
<span class="fc" id="L838">                                        (String) ((Map&lt;?, ?&gt;) profileDetailsMap.get(Constants.EMPLOYMENT_DETAILS)).get(Constants.DEPARTMENT_KEY))) {</span>
<span class="fc" id="L839">                                    userMap.put(Constants.DEPARTMENT, (String) ((Map&lt;?, ?&gt;) profileDetailsMap.get(Constants.EMPLOYMENT_DETAILS)).get(Constants.DEPARTMENT_KEY));</span>

                                }
                            }
<span class="fc" id="L843">                        } catch (JsonProcessingException e) {</span>
<span class="fc" id="L844">                            log.error(&quot;Error occurred while converting json object to json string&quot;, e);</span>
<span class="fc" id="L845">                        }</span>
                    }

<span class="fc" id="L848">                    return userMap;</span>
                })
<span class="fc" id="L850">                .collect(Collectors.toList());</span>
<span class="fc" id="L851">        return userList;</span>
    }

    @Override
    public ApiResponse createAnswerPost(JsonNode answerPostData, String token) {
<span class="fc" id="L856">        log.info(&quot;DiscussionService::createAnswerPost:creating answerPost&quot;);</span>
<span class="fc" id="L857">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;discussion.createAnswerPost&quot;);</span>
<span class="fc" id="L858">        payloadValidation.validatePayload(Constants.DISCUSSION_ANSWER_POST_VALIDATION_SCHEMA, answerPostData);</span>
<span class="fc" id="L859">        String userId = accessTokenValidator.verifyUserToken(token);</span>
<span class="pc bpc" id="L860" title="1 of 4 branches missed.">        if (StringUtils.isBlank(userId) || userId.equals(Constants.UNAUTHORIZED)) {</span>
<span class="fc" id="L861">            response.getParams().setErrMsg(Constants.INVALID_AUTH_TOKEN);</span>
<span class="fc" id="L862">            response.setResponseCode(HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L863">            return response;</span>
        }
<span class="fc" id="L865">        updateMetricsApiCall(Constants.DISCUSSION_ANSWER_POST);</span>
<span class="fc" id="L866">        long postgresTime = System.currentTimeMillis();</span>
<span class="fc" id="L867">        DiscussionEntity discussionEntity = discussionRepository.findById(answerPostData.get(Constants.PARENT_DISCUSSION_ID).asText()).orElse(null);</span>
<span class="fc" id="L868">        updateMetricsDbOperation(Constants.DISCUSSION_ANSWER_POST, Constants.POSTGRES, Constants.READ, postgresTime);</span>
<span class="fc bfc" id="L869" title="All 4 branches covered.">        if (discussionEntity == null || !discussionEntity.getIsActive()) {</span>
<span class="fc" id="L870">            return ProjectUtil.returnErrorMsg(Constants.INVALID_PARENT_DISCUSSION_ID, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }
<span class="fc" id="L872">        JsonNode data = discussionEntity.getData();</span>
<span class="fc" id="L873">        String type = data.get(Constants.TYPE).asText();</span>
<span class="fc bfc" id="L874" title="All 2 branches covered.">        if (type.equals(Constants.ANSWER_POST)) {</span>
<span class="fc" id="L875">            return ProjectUtil.returnErrorMsg(Constants.PARENT_ANSWER_POST_ID_ERROR, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }
<span class="fc bfc" id="L877" title="All 2 branches covered.">        if (data.get(Constants.STATUS).asText().equals(Constants.SUSPENDED)) {</span>
<span class="fc" id="L878">            return ProjectUtil.returnErrorMsg(Constants.PARENT_DISCUSSION_ID_ERROR, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }
<span class="fc bfc" id="L880" title="All 2 branches covered.">        if (!answerPostData.get(Constants.COMMUNITY_ID).asText().equals(data.get(Constants.COMMUNITY_ID).asText())) {</span>
<span class="fc" id="L881">            response.getParams().setErrMsg(Constants.INVALID_COMMUNITY_ID);</span>
<span class="fc" id="L882">            response.setResponseCode(HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L883">            return response;</span>
        }

        try {
<span class="fc" id="L887">            JsonNode mentionedUsersNode = answerPostData.get(MENTIONED_USERS);</span>
<span class="fc" id="L888">            List&lt;String&gt; userIdList = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L889" title="5 of 6 branches missed.">            if (mentionedUsersNode != null &amp;&amp; mentionedUsersNode.isArray() &amp;&amp; mentionedUsersNode.size() &gt; 0) {</span>
<span class="nc" id="L890">                Map&lt;String, JsonNode&gt; uniqueUserMap = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L891">                mentionedUsersNode.forEach(node -&gt; {</span>
<span class="nc" id="L892">                    String userid = node.path(USER_ID_RQST).asText(null);</span>
<span class="nc bnc" id="L893" title="All 4 branches missed.">                    if (StringUtils.isNotBlank(userid) &amp;&amp; !uniqueUserMap.containsKey(userid)) {</span>
<span class="nc" id="L894">                        uniqueUserMap.put(userid, node);</span>
                    }
<span class="nc" id="L896">                });</span>
<span class="nc" id="L897">                ArrayNode cleanArray = objectMapper.createArrayNode();</span>
<span class="nc" id="L898">                uniqueUserMap.values().forEach(cleanArray::add);</span>
<span class="nc" id="L899">                ((ObjectNode) answerPostData).set(MENTIONED_USERS, cleanArray);</span>
<span class="nc" id="L900">                userIdList.addAll(uniqueUserMap.keySet());</span>
            }
<span class="fc" id="L902">            ObjectNode answerPostDataNode = (ObjectNode) answerPostData;</span>
<span class="fc" id="L903">            Map&lt;String, Object&gt; propertyMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L904">            propertyMap.put(Constants.USERID, userId);</span>
<span class="fc" id="L905">            propertyMap.put(Constants.COMMUNITY_ID, answerPostDataNode.get(Constants.COMMUNITY_ID).asText());</span>
<span class="fc" id="L906">            List&lt;Map&lt;String, Object&gt;&gt; communityDetails = cassandraOperation.getRecordsByPropertiesWithoutFiltering(Constants.KEYSPACE_SUNBIRD, Constants.USER_COMMUNITY, propertyMap, Arrays.asList(Constants.STATUS), null);</span>
<span class="pc bpc" id="L907" title="1 of 4 branches missed.">            if (communityDetails.isEmpty() || !(boolean) communityDetails.get(0).get(Constants.STATUS)) {</span>
<span class="fc" id="L908">                DiscussionServiceUtil.createErrorResponse(response, Constants.USER_NOT_PART_OF_COMMUNITY, HttpStatus.BAD_REQUEST, Constants.FAILED);</span>
<span class="fc" id="L909">                return response;</span>
            }
<span class="fc" id="L911">            answerPostDataNode.put(Constants.CREATED_BY, userId);</span>
<span class="fc" id="L912">            answerPostDataNode.put(Constants.VOTE_COUNT, 0);</span>
<span class="fc" id="L913">            answerPostDataNode.put(Constants.STATUS, Constants.ACTIVE);</span>
<span class="fc" id="L914">            answerPostDataNode.put(Constants.PARENT_DISCUSSION_ID, answerPostData.get(Constants.PARENT_DISCUSSION_ID));</span>

<span class="fc" id="L916">            DiscussionEntity jsonNodeEntity = new DiscussionEntity();</span>

<span class="fc" id="L918">            Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span>
<span class="fc" id="L919">            UUID id = Uuids.timeBased();</span>
<span class="fc" id="L920">            answerPostDataNode.put(Constants.DISCUSSION_ID, String.valueOf(id));</span>
<span class="fc" id="L921">            jsonNodeEntity.setDiscussionId(String.valueOf(id));</span>
<span class="fc" id="L922">            jsonNodeEntity.setCreatedOn(currentTime);</span>
<span class="fc" id="L923">            answerPostDataNode.put(Constants.CREATED_ON, getFormattedCurrentTime(currentTime));</span>
<span class="fc" id="L924">            answerPostDataNode.put(Constants.UPDATED_ON, getFormattedCurrentTime(currentTime));</span>
<span class="fc" id="L925">            jsonNodeEntity.setIsActive(true);</span>
<span class="fc" id="L926">            answerPostDataNode.put(Constants.IS_ACTIVE, true);</span>
<span class="fc" id="L927">            jsonNodeEntity.setData(answerPostDataNode);</span>
<span class="fc" id="L928">            jsonNodeEntity.setCreatedOn(currentTime);</span>
<span class="fc" id="L929">            jsonNodeEntity.setUpdatedOn(currentTime);</span>
<span class="fc" id="L930">            jsonNodeEntity.setIsProfane(false);</span>
<span class="fc" id="L931">            long timer = System.currentTimeMillis();</span>
<span class="fc" id="L932">            discussionRepository.save(jsonNodeEntity);</span>
<span class="fc" id="L933">            updateMetricsDbOperation(Constants.DISCUSSION_ANSWER_POST, Constants.POSTGRES, Constants.INSERT, timer);</span>

<span class="fc" id="L935">            ObjectNode jsonNode = objectMapper.createObjectNode();</span>
<span class="fc" id="L936">            jsonNode.setAll(answerPostDataNode);</span>
<span class="fc" id="L937">            Map&lt;String, Object&gt; discussionAnswerPostDetailsMap = objectMapper.convertValue(jsonNode, Map.class);</span>
<span class="nc" id="L938">            discussionAnswerPostDetailsMap.put(IS_PROFANE,false);</span>
<span class="nc" id="L939">            esUtilService.addDocument(cbServerProperties.getDiscussionEntity(), String.valueOf(id), discussionAnswerPostDetailsMap, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="nc" id="L940">            cacheService.putCache(Constants.DISCUSSION_CACHE_PREFIX + String.valueOf(id), jsonNode);</span>

<span class="nc" id="L942">            updateAnswerPostToDiscussion(discussionEntity, String.valueOf(id), Constants.INCREMENT);</span>
<span class="nc" id="L943">            deleteCacheByCommunity(Constants.DISCUSSION_CACHE_PREFIX + answerPostData.get(Constants.COMMUNITY_ID).asText());</span>
<span class="nc" id="L944">            updateCacheForFirstFivePages(answerPostData.get(Constants.COMMUNITY_ID).asText(), false);</span>
<span class="nc" id="L945">            redisTemplate.opsForValue()</span>
<span class="nc" id="L946">                    .getAndDelete(DiscussionServiceUtil.generateRedisJwtTokenKey(createSearchCriteriaWithDefaults(</span>
<span class="nc" id="L947">                            answerPostData.get(Constants.PARENT_DISCUSSION_ID).asText(),</span>
<span class="nc" id="L948">                            answerPostData.get(Constants.COMMUNITY_ID).asText(),</span>
                            Constants.ANSWER_POST)));
            // update global feed cache
<span class="nc" id="L951">            updateCacheForGlobalFeed(userId);</span>
<span class="nc" id="L952">            Map&lt;String, String&gt; communityObject = new HashMap&lt;&gt;();</span>
<span class="nc" id="L953">            communityObject.put(Constants.COMMUNITY_ID, answerPostData.get(Constants.COMMUNITY_ID).asText());</span>
<span class="nc" id="L954">            communityObject.put(Constants.STATUS, Constants.INCREMENT);</span>
<span class="nc" id="L955">            communityObject.put(Constants.TYPE, Constants.ANSWER_POST);</span>
<span class="nc" id="L956">            producer.push(cbServerProperties.getCommunityPostCount(), communityObject);</span>

<span class="nc" id="L958">            log.info(&quot;AnswerPost created successfully&quot;);</span>

            try {
<span class="nc" id="L961">                Map&lt;String, Object&gt; notificationData = Map.of(</span>
<span class="nc" id="L962">                        Constants.COMMUNITY_ID, answerPostData.get(Constants.COMMUNITY_ID).asText(),</span>
<span class="nc" id="L963">                        Constants.DISCUSSION_ID, answerPostData.get(Constants.PARENT_DISCUSSION_ID).asText()</span>
                );
<span class="nc" id="L965">                String discussionOwner = discussionEntity.getData().get(Constants.CREATED_BY).asText();</span>
<span class="nc" id="L966">                String createdBy = answerPostData.get(CREATED_BY).asText();</span>
<span class="nc" id="L967">                String firstName = helperMethodService.fetchUserFirstName(createdBy);</span>
<span class="nc" id="L968">                log.info(&quot;Notification trigger started for create answerPost&quot;);</span>
<span class="nc bnc" id="L969" title="All 2 branches missed.">                if (!userId.equals(discussionOwner)) {</span>
<span class="nc" id="L970">                    notificationTriggerService.triggerNotification(LIKED_COMMENT, ENGAGEMENT, List.of(discussionOwner), TITLE, firstName, notificationData);</span>
                }
<span class="nc bnc" id="L972" title="All 2 branches missed.">                if (CollectionUtils.isNotEmpty(userIdList)) {</span>
<span class="nc" id="L973">                    List&lt;String&gt; filteredUserIdList = userIdList.stream()</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">                            .filter(uniqueId -&gt; !uniqueId.equals(discussionOwner)).toList();</span>

<span class="nc bnc" id="L976" title="All 2 branches missed.">                    if (CollectionUtils.isNotEmpty(filteredUserIdList)) {</span>
<span class="nc" id="L977">                        Map&lt;String, Object&gt; answerPostNotificationData = Map.of(</span>
<span class="nc" id="L978">                                Constants.COMMUNITY_ID, answerPostData.get(Constants.COMMUNITY_ID).asText(),</span>
<span class="nc" id="L979">                                Constants.DISCUSSION_ID, jsonNodeEntity.getDiscussionId()</span>
                        );
<span class="nc" id="L981">                        notificationTriggerService.triggerNotification(TAGGED_COMMENT, ENGAGEMENT, filteredUserIdList, TITLE, firstName, answerPostNotificationData);</span>
                    }
                }
<span class="nc" id="L984">            } catch (Exception e) {</span>
<span class="nc" id="L985">                log.error(&quot;Error while triggering notification&quot;, e);</span>
<span class="nc" id="L986">            }</span>
<span class="nc" id="L987">            discussionAnswerPostDetailsMap.put(Constants.CREATED_ON, currentTime);</span>
<span class="nc" id="L988">            response.setResponseCode(HttpStatus.CREATED);</span>
<span class="nc" id="L989">            response.getParams().setStatus(Constants.SUCCESS);</span>
<span class="nc" id="L990">            response.setResult(discussionAnswerPostDetailsMap);</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">            if (answerPostData.hasNonNull(Constants.LANGUAGE)) {</span>
<span class="nc" id="L992">                profanityCheckService.processProfanityCheck(String.valueOf(id), answerPostDataNode);</span>
            }
<span class="fc" id="L994">        } catch (Exception e) {</span>
<span class="fc" id="L995">            log.error(&quot;Failed to create AnswerPost: {}&quot;, e.getMessage(), e);</span>
<span class="fc" id="L996">            DiscussionServiceUtil.createErrorResponse(response, Constants.FAILED_TO_CREATE_ANSWER_POST, HttpStatus.INTERNAL_SERVER_ERROR, Constants.FAILED);</span>
<span class="fc" id="L997">            return response;</span>
<span class="nc" id="L998">        }</span>
<span class="nc" id="L999">        return response;</span>
    }

    private SearchCriteria createSearchCriteriaWithDefaults(String parentDiscussionId,
                                                            String communityId,
                                                            String type) {
<span class="fc" id="L1005">        SearchCriteria criteria = new SearchCriteria();</span>

        // Initialize filterCriteriaMap with default and specified values
<span class="fc" id="L1008">        HashMap&lt;String, Object&gt; filterMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1009">        filterMap.put(Constants.COMMUNITY_ID, communityId);</span>
<span class="fc" id="L1010">        filterMap.put(Constants.TYPE, type);</span>
<span class="fc" id="L1011">        filterMap.put(Constants.PARENT_DISCUSSION_ID, parentDiscussionId);</span>
<span class="fc" id="L1012">        criteria.setFilterCriteriaMap(filterMap);</span>
        // Initialize requestedFields with an empty list
<span class="fc" id="L1014">        criteria.setRequestedFields(Collections.emptyList());</span>

        // Set default pagination values
<span class="fc" id="L1017">        criteria.setPageNumber(0);</span>
<span class="fc" id="L1018">        criteria.setPageSize(10);</span>

        // Set default ordering
<span class="fc" id="L1021">        criteria.setOrderBy(Constants.CREATED_ON);</span>
<span class="fc" id="L1022">        criteria.setOrderDirection(Constants.DESC);</span>

        // Initialize facets with an empty list
<span class="fc" id="L1025">        criteria.setFacets(Collections.emptyList());</span>
<span class="fc" id="L1026">        return criteria;</span>

    }

    private void updateAnswerPostToDiscussion(DiscussionEntity discussionEntity, String discussionId, String action) {
<span class="nc" id="L1031">        log.info(&quot;DiscussionService::updateAnswerPostToDiscussion:inside&quot;);</span>
<span class="nc" id="L1032">        JsonNode data = discussionEntity.getData();</span>
<span class="nc" id="L1033">        Set&lt;String&gt; answerPostSet = new HashSet&lt;&gt;();</span>

<span class="nc bnc" id="L1035" title="All 2 branches missed.">        if (data.has(Constants.ANSWER_POSTS)) {</span>
<span class="nc" id="L1036">            ArrayNode existingAnswerPosts = (ArrayNode) data.get(Constants.ANSWER_POSTS);</span>
<span class="nc" id="L1037">            existingAnswerPosts.forEach(post -&gt; answerPostSet.add(post.asText()));</span>
        }
<span class="nc bnc" id="L1039" title="All 2 branches missed.">        if (Constants.INCREMENT.equals(action)) {</span>
<span class="nc" id="L1040">            answerPostSet.add(discussionId);</span>
        } else {
<span class="nc" id="L1042">            answerPostSet.remove(discussionId);</span>
        }
<span class="nc" id="L1044">        ArrayNode arrayNode = objectMapper.valueToTree(answerPostSet);</span>
<span class="nc" id="L1045">        ((ObjectNode) data).put(Constants.ANSWER_POSTS, arrayNode);</span>
<span class="nc" id="L1046">        ((ObjectNode) data).put(Constants.ANSWER_POST_COUNT, answerPostSet.size());</span>

<span class="nc" id="L1048">        discussionEntity.setData(data);</span>
<span class="nc" id="L1049">        DiscussionEntity savedEntity = discussionRepository.save(discussionEntity);</span>
<span class="nc" id="L1050">        log.info(&quot;DiscussionService::updateAnswerPostToDiscussion: Discussion entity updated successfully&quot;);</span>

<span class="nc" id="L1052">        ObjectNode jsonNode = objectMapper.createObjectNode();</span>
<span class="nc" id="L1053">        jsonNode.setAll((ObjectNode) savedEntity.getData());</span>
<span class="nc" id="L1054">        Map&lt;String, Object&gt; map = objectMapper.convertValue(jsonNode, Map.class);</span>

<span class="nc" id="L1056">        esUtilService.updateDocument(cbServerProperties.getDiscussionEntity(), discussionEntity.getDiscussionId(), map, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="nc" id="L1057">        cacheService.putCache(Constants.DISCUSSION_CACHE_PREFIX + discussionEntity.getDiscussionId(), jsonNode);</span>
<span class="nc" id="L1058">    }</span>

    @Override
    public ApiResponse upVote(String discussionId, String type, String token) {
<span class="fc" id="L1062">        return vote(discussionId, type, token, Constants.UP);</span>
    }

    @Override
    public ApiResponse downVote(String discussionId, String type, String token) {
<span class="nc" id="L1067">        return vote(discussionId, type, token, Constants.DOWN);</span>
    }

    @Override
    public ApiResponse report(String token, Map&lt;String, Object&gt; reportData) {
<span class="fc" id="L1072">        log.info(&quot;DiscussionService::report: Reporting discussion&quot;);</span>
<span class="fc" id="L1073">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;discussion.report&quot;);</span>
<span class="fc" id="L1074">        String errorMsg = validateReportPayload(reportData);</span>
<span class="fc bfc" id="L1075" title="All 2 branches covered.">        if (StringUtils.isNotEmpty(errorMsg)) {</span>
<span class="fc" id="L1076">            return ProjectUtil.returnErrorMsg(errorMsg, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }

<span class="fc" id="L1079">        String userId = accessTokenValidator.verifyUserToken(token);</span>
<span class="pc bpc" id="L1080" title="1 of 4 branches missed.">        if (StringUtils.isBlank(userId) || Constants.UNAUTHORIZED.equals(userId)) {</span>
<span class="fc" id="L1081">            return ProjectUtil.returnErrorMsg(Constants.INVALID_AUTH_TOKEN, HttpStatus.UNAUTHORIZED, response, Constants.FAILED);</span>
        }

        try {
<span class="fc" id="L1085">            String discussionId = (String) reportData.get(Constants.DISCUSSION_ID);</span>
<span class="fc" id="L1086">            String discussionText = (String) reportData.get(Constants.DISCUSSION_TEXT);</span>
<span class="fc" id="L1087">            String type = (String) reportData.get(Constants.TYPE);</span>
<span class="fc bfc" id="L1088" title="All 2 branches covered.">            Object entityObject = Constants.ANSWER_POST_REPLY.equals(type)</span>
<span class="fc" id="L1089">                    ? discussionAnswerPostReplyRepository.findById(discussionId).orElse(null)</span>
<span class="fc" id="L1090">                    : discussionRepository.findById(discussionId).orElse(null);</span>

<span class="fc bfc" id="L1092" title="All 2 branches covered.">            if (entityObject == null) {</span>
<span class="fc" id="L1093">                return ProjectUtil.returnErrorMsg(Constants.DISCUSSION_NOT_FOUND, HttpStatus.NOT_FOUND, response, Constants.FAILED);</span>
            }

            JsonNode dataNode;
            Boolean isActive;
<span class="fc bfc" id="L1098" title="All 2 branches covered.">            if (Constants.ANSWER_POST_REPLY.equals(type)) {</span>
<span class="fc" id="L1099">                DiscussionAnswerPostReplyEntity replyEntity = (DiscussionAnswerPostReplyEntity) entityObject;</span>
<span class="fc" id="L1100">                dataNode = replyEntity.getData();</span>
<span class="fc" id="L1101">                isActive = replyEntity.getIsActive();</span>
<span class="fc" id="L1102">            } else {</span>
<span class="fc" id="L1103">                DiscussionEntity discussionEntity = (DiscussionEntity) entityObject;</span>
<span class="fc" id="L1104">                dataNode = discussionEntity.getData();</span>
<span class="fc" id="L1105">                isActive = discussionEntity.getIsActive();</span>
            }

<span class="fc" id="L1108">            ObjectNode data = (ObjectNode) dataNode;</span>
<span class="fc bfc" id="L1109" title="All 2 branches covered.">            if (!isActive) {</span>
<span class="fc" id="L1110">                return ProjectUtil.returnErrorMsg(Constants.DISCUSSION_IS_INACTIVE, HttpStatus.CONFLICT, response, Constants.FAILED);</span>
            }

<span class="fc bfc" id="L1113" title="All 2 branches covered.">            if (!type.equals(data.get(Constants.TYPE).asText())) {</span>
<span class="fc" id="L1114">                return ProjectUtil.returnErrorMsg(Constants.INVALID_TYPE + type, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
            }

<span class="fc bfc" id="L1117" title="All 2 branches covered.">            if (Constants.SUSPENDED.equals(data.get(Constants.STATUS).asText())) {</span>
<span class="fc" id="L1118">                return ProjectUtil.returnErrorMsg(Constants.DISCUSSION_SUSPENDED, HttpStatus.CONFLICT, response, Constants.FAILED);</span>
            }

            // Check if the user has already reported the discussion
<span class="fc" id="L1122">            Map&lt;String, Object&gt; reportCheckData = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1123">            reportCheckData.put(Constants.USERID, userId);</span>
<span class="fc" id="L1124">            reportCheckData.put(Constants.DISCUSSION_ID, discussionId);</span>
<span class="fc" id="L1125">            List&lt;Map&lt;String, Object&gt;&gt; existingReports = cassandraOperation.getRecordsByPropertiesWithoutFiltering(</span>
                    Constants.KEYSPACE_SUNBIRD, Constants.DISCUSSION_POST_REPORT_LOOKUP_BY_USER, reportCheckData, null, null);

<span class="fc bfc" id="L1128" title="All 2 branches covered.">            if (!existingReports.isEmpty()) {</span>
<span class="fc" id="L1129">                return ProjectUtil.returnErrorMsg(&quot;User has already reported this post&quot;, HttpStatus.ALREADY_REPORTED, response, Constants.SUCCESS);</span>
            }

            // Store user data in Cassandra
<span class="fc" id="L1133">            Map&lt;String, Object&gt; userReportData = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1134">            userReportData.put(Constants.USERID, userId);</span>
<span class="fc" id="L1135">            userReportData.put(Constants.DISCUSSION_ID, discussionId);</span>
<span class="fc bfc" id="L1136" title="All 2 branches covered.">            if (StringUtils.isNotBlank(discussionText)) {</span>
<span class="fc" id="L1137">                userReportData.put(Constants.DISCUSSION_TEXT, discussionText);</span>
            }
<span class="pc bpc" id="L1139" title="1 of 2 branches missed.">            if (reportData.containsKey(Constants.REPORTED_REASON)) {</span>
<span class="fc" id="L1140">                List&lt;String&gt; reportedReasonList = (List&lt;String&gt;) reportData.get(Constants.REPORTED_REASON);</span>
<span class="pc bpc" id="L1141" title="2 of 4 branches missed.">                if (reportedReasonList != null &amp;&amp; !reportedReasonList.isEmpty()) {</span>
<span class="fc" id="L1142">                    StringBuilder reasonBuilder = new StringBuilder(String.join(&quot;, &quot;, reportedReasonList));</span>

<span class="pc bpc" id="L1144" title="1 of 4 branches missed.">                    if (reportedReasonList.contains(Constants.OTHERS) &amp;&amp; reportData.containsKey(Constants.OTHER_REASON)) {</span>
<span class="fc" id="L1145">                        reasonBuilder.append(&quot;, &quot;).append(reportData.get(Constants.OTHER_REASON));</span>
                    }
<span class="fc" id="L1147">                    userReportData.put(Constants.REASON, reasonBuilder.toString());</span>
                }
            }
<span class="fc" id="L1150">            Instant now = Instant.now();</span>
<span class="fc" id="L1151">            Timestamp currentTime = Timestamp.from(now);</span>
<span class="fc" id="L1152">            data.put(Constants.RECENT_REPORTED_ON, getFormattedCurrentTime(currentTime));</span>
<span class="fc" id="L1153">            userReportData.put(Constants.CREATED_ON, now);</span>
<span class="fc" id="L1154">            cassandraOperation.insertRecord(Constants.KEYSPACE_SUNBIRD, Constants.DISCUSSION_POST_REPORT_LOOKUP_BY_USER, userReportData);</span>
<span class="fc" id="L1155">            cassandraOperation.insertRecord(Constants.KEYSPACE_SUNBIRD, Constants.DISCUSSION_POST_REPORT_LOOKUP_BY_POST, userReportData);</span>

            // Update the status of the discussion in Cassandra
            String status;
<span class="pc bpc" id="L1159" title="1 of 2 branches missed.">            if (cbServerProperties.isDiscussionReportHidePost()) {</span>
<span class="fc" id="L1160">                List&lt;Map&lt;String, Object&gt;&gt; reportedByUsers = cassandraOperation.getRecordsByPropertiesWithoutFiltering(</span>
<span class="fc" id="L1161">                        Constants.KEYSPACE_SUNBIRD, Constants.DISCUSSION_POST_REPORT_LOOKUP_BY_POST, Collections.singletonMap(Constants.DISCUSSION_ID, discussionId), null, null);</span>
<span class="pc bpc" id="L1162" title="3 of 4 branches missed.">                status = CollectionUtils.isNotEmpty(reportedByUsers) &amp;&amp; reportedByUsers.size() &gt;= cbServerProperties.getReportPostUserLimit()</span>
<span class="nc" id="L1163">                        ? Constants.SUSPENDED</span>
<span class="fc" id="L1164">                        : Constants.REPORTED;</span>
<span class="fc" id="L1165">            } else {</span>
<span class="nc" id="L1166">                status = Constants.REPORTED;</span>
            }

<span class="fc" id="L1169">            ObjectNode jsonNode = objectMapper.createObjectNode();</span>
<span class="pc bpc" id="L1170" title="1 of 2 branches missed.">            if (!data.get(Constants.STATUS).textValue().equals(status)) {</span>
<span class="fc" id="L1171">                data.put(Constants.STATUS, status);</span>
            }

            ArrayNode reportedByArray;
<span class="pc bpc" id="L1175" title="1 of 2 branches missed.">            if (data.has(Constants.REPORTED_BY)) {</span>
<span class="nc" id="L1176">                reportedByArray = (ArrayNode) data.get(Constants.REPORTED_BY);</span>
            } else {
<span class="fc" id="L1178">                reportedByArray = objectMapper.createArrayNode();</span>
<span class="fc" id="L1179">                data.set(Constants.REPORTED_BY, reportedByArray);</span>
            }
<span class="fc" id="L1181">            reportedByArray.add(userId);</span>
<span class="pc bpc" id="L1182" title="1 of 2 branches missed.">            if (Constants.ANSWER_POST_REPLY.equals(type)) {</span>
<span class="fc" id="L1183">                DiscussionAnswerPostReplyEntity replyEntity = (DiscussionAnswerPostReplyEntity) entityObject;</span>
<span class="fc" id="L1184">                replyEntity.setData(dataNode);</span>
<span class="fc" id="L1185">                discussionAnswerPostReplyRepository.save(replyEntity);</span>
<span class="fc" id="L1186">            } else {</span>
<span class="nc" id="L1187">                DiscussionEntity discussionEntity = (DiscussionEntity) entityObject;</span>
<span class="nc" id="L1188">                discussionEntity.setData(dataNode);</span>
<span class="nc" id="L1189">                discussionRepository.save(discussionEntity);</span>
            }
<span class="fc" id="L1191">            jsonNode.setAll(data);</span>
<span class="fc" id="L1192">            Map&lt;String, Object&gt; map = objectMapper.convertValue(jsonNode, Map.class);</span>
<span class="fc" id="L1193">            esUtilService.updateDocument(cbServerProperties.getDiscussionEntity(), discussionId, map, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="fc" id="L1194">            cacheService.putCache(Constants.DISCUSSION_CACHE_PREFIX + discussionId, jsonNode);</span>

<span class="pc bpc" id="L1196" title="1 of 2 branches missed.">            if (Constants.ANSWER_POST_REPLY.equals(type)) {</span>
<span class="fc" id="L1197">                redisTemplate.opsForValue()</span>
<span class="fc" id="L1198">                        .getAndDelete(DiscussionServiceUtil.generateRedisJwtTokenKey(createDefaultSearchCriteria(</span>
<span class="fc" id="L1199">                                data.get(Constants.PARENT_ANSWER_POST_ID).asText(),</span>
<span class="fc" id="L1200">                                data.get(Constants.COMMUNITY_ID).asText())));</span>
            } else {
<span class="nc" id="L1202">                deleteCacheByCommunity(Constants.DISCUSSION_CACHE_PREFIX + data.get(Constants.COMMUNITY_ID).asText());</span>
<span class="nc" id="L1203">                updateCacheForFirstFivePages(data.get(Constants.COMMUNITY_ID).asText(), false);</span>
<span class="nc" id="L1204">                updateCacheForGlobalFeed(userId);</span>
            }
<span class="pc bpc" id="L1206" title="1 of 2 branches missed.">            if (status.equals(Constants.SUSPENDED)) {</span>
<span class="nc" id="L1207">                deleteCacheByCommunity(SUSPENDED_POSTS_CACHE_PREFIX + data.get(Constants.COMMUNITY_ID).asText());</span>
<span class="nc" id="L1208">                deleteCacheByCommunity(ALL_REPORTED_POSTS_CACHE_PREFIX + data.get(Constants.COMMUNITY_ID).asText());</span>
            }
<span class="pc bpc" id="L1210" title="1 of 2 branches missed.">            if (status.equals(REPORTED)) {</span>
<span class="fc" id="L1211">                deleteCacheByCommunity(ALL_REPORTED_POSTS_CACHE_PREFIX + data.get(COMMUNITY_ID).asText());</span>
            }
<span class="pc bpc" id="L1213" title="1 of 2 branches missed.">            if (QUESTION.equals(type)) {</span>
<span class="nc" id="L1214">                deleteCacheByCommunity(REPORTED_QUESTION_POSTS_CACHE_PREFIX + data.get(COMMUNITY_ID).asText());</span>
<span class="pc bpc" id="L1215" title="1 of 2 branches missed.">            } else if (ANSWER_POST.equals(type)) {</span>
<span class="nc" id="L1216">                deleteCacheByCommunity(REPORTED_ANSWER_POST_POSTS_CACHE_PREFIX + data.get(COMMUNITY_ID).asText());</span>
<span class="pc bpc" id="L1217" title="1 of 2 branches missed.">            } else if (ANSWER_POST_REPLY.equals(type)) {</span>
<span class="fc" id="L1218">                deleteCacheByCommunity(REPORTED_ANSWER_POST_REPLY_POSTS_CACHE_PREFIX + data.get(COMMUNITY_ID).asText());</span>
            }
<span class="fc" id="L1220">            String redisKey = Constants.REPORT_STATISTICS_CACHE_PREFIX + discussionId;</span>
<span class="fc" id="L1221">            cacheService.deleteCache(redisKey);</span>
<span class="fc" id="L1222">            log.info(&quot;Updated cache for global feed&quot;);</span>
<span class="fc" id="L1223">            map.put(Constants.DISCUSSION_ID, reportData.get(Constants.DISCUSSION_ID));</span>
<span class="fc" id="L1224">            response.setResult(map);</span>
<span class="fc" id="L1225">            return response;</span>
<span class="fc" id="L1226">        } catch (Exception e) {</span>
<span class="fc" id="L1227">            log.error(&quot;DiscussionService::report: Failed to report discussion&quot;, e);</span>
<span class="fc" id="L1228">            return ProjectUtil.returnErrorMsg(Constants.DISCUSSION_REPORT_FAILED, HttpStatus.INTERNAL_SERVER_ERROR, response, Constants.FAILED);</span>
        }
    }

    private String validateReportPayload(Map&lt;String, Object&gt; reportData) {
<span class="fc" id="L1233">        StringBuffer errorMsg = new StringBuffer();</span>
<span class="fc" id="L1234">        List&lt;String&gt; errList = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L1236" title="1 of 4 branches missed.">        if (reportData.containsKey(Constants.DISCUSSION_ID) &amp;&amp; StringUtils.isBlank((String) reportData.get(Constants.DISCUSSION_ID))) {</span>
<span class="fc" id="L1237">            errList.add(Constants.DISCUSSION_ID);</span>
        }
<span class="pc bpc" id="L1239" title="1 of 4 branches missed.">        if (reportData.containsKey(Constants.TYPE) &amp;&amp; StringUtils.isBlank((String) reportData.get(Constants.TYPE))) {</span>
<span class="nc" id="L1240">            errList.add(Constants.TYPE);</span>
        }
<span class="fc bfc" id="L1242" title="All 2 branches covered.">        if (reportData.containsKey(Constants.REPORTED_REASON)) {</span>
<span class="fc" id="L1243">            Object reportedReasonObj = reportData.get(Constants.REPORTED_REASON);</span>
<span class="pc bpc" id="L1244" title="1 of 2 branches missed.">            if (reportedReasonObj instanceof List) {</span>
<span class="fc" id="L1245">                List&lt;String&gt; reportedReasonList = (List&lt;String&gt;) reportedReasonObj;</span>
<span class="pc bpc" id="L1246" title="1 of 2 branches missed.">                if (reportedReasonList.isEmpty()) {</span>
<span class="nc" id="L1247">                    errList.add(Constants.REPORTED_REASON);</span>
<span class="fc bfc" id="L1248" title="All 2 branches covered.">                } else if (reportedReasonList.contains(Constants.OTHERS)) {</span>
<span class="pc bpc" id="L1249" title="1 of 2 branches missed.">                    if (!reportData.containsKey(Constants.OTHER_REASON) ||</span>
<span class="pc bpc" id="L1250" title="1 of 2 branches missed.">                            StringUtils.isBlank((String) reportData.get(Constants.OTHER_REASON))) {</span>
<span class="nc" id="L1251">                        errList.add(Constants.OTHER_REASON);</span>
                    }
                }
<span class="fc" id="L1254">            } else {</span>
<span class="nc" id="L1255">                errList.add(Constants.REPORTED_REASON);</span>
            }
        }
<span class="fc bfc" id="L1258" title="All 2 branches covered.">        if (!errList.isEmpty()) {</span>
<span class="fc" id="L1259">            errorMsg.append(&quot;Failed Due To Missing Params - &quot;).append(errList).append(&quot;.&quot;);</span>
        }
<span class="fc" id="L1261">        return errorMsg.toString();</span>
    }


    @Override
    public ApiResponse uploadFile(MultipartFile mFile, String communityId, String discussionId) {
<span class="fc" id="L1267">        ApiResponse response = ProjectUtil.createDefaultResponse(Constants.DISCUSSION_UPLOAD_FILE);</span>
<span class="fc bfc" id="L1268" title="All 2 branches covered.">        if (mFile.isEmpty()) {</span>
<span class="fc" id="L1269">            return ProjectUtil.returnErrorMsg(Constants.DISCUSSION_FILE_EMPTY, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }
<span class="fc bfc" id="L1271" title="All 2 branches covered.">        if (StringUtils.isBlank(discussionId)) {</span>
<span class="fc" id="L1272">            return ProjectUtil.returnErrorMsg(Constants.INVALID_DISCUSSION_ID, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }
<span class="fc bfc" id="L1274" title="All 2 branches covered.">        if (StringUtils.isBlank(communityId)) {</span>
<span class="fc" id="L1275">            return ProjectUtil.returnErrorMsg(Constants.INVALID_COMMUNITY_ID, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }

<span class="fc" id="L1278">        File file = null;</span>
        try {
<span class="fc" id="L1280">            file = new File(System.currentTimeMillis() + Constants.UNDER_SCORE + mFile.getOriginalFilename());</span>

<span class="fc" id="L1282">            file.createNewFile();</span>
            // Use try-with-resources to ensure FileOutputStream is closed
<span class="fc" id="L1284">            try (FileOutputStream fos = new FileOutputStream(file)) {</span>
<span class="fc" id="L1285">                fos.write(mFile.getBytes());</span>
            }

<span class="fc" id="L1288">            String uploadFolderPath = cbServerProperties.getDiscussionCloudFolderName() + &quot;/&quot; + communityId + &quot;/&quot; + discussionId;</span>
<span class="fc" id="L1289">            return uploadFile(file, uploadFolderPath, cbServerProperties.getDiscussionContainerName());</span>
<span class="fc" id="L1290">        } catch (Exception e) {</span>
<span class="fc" id="L1291">            log.error(&quot;Failed to upload file. Exception: &quot;, e);</span>
<span class="fc" id="L1292">            response.getParams().setStatus(Constants.FAILED);</span>
<span class="fc" id="L1293">            response.getParams().setErrMsg(&quot;Failed to upload file. Exception: &quot; + e.getMessage());</span>
<span class="fc" id="L1294">            response.setResponseCode(HttpStatus.INTERNAL_SERVER_ERROR);</span>
<span class="fc" id="L1295">            return response;</span>
        } finally {
<span class="pc bpc" id="L1297" title="2 of 4 branches missed.">            if (file != null &amp;&amp; file.exists()) {</span>
<span class="fc" id="L1298">                file.delete();</span>
            }
        }
    }

    public ApiResponse uploadFile(File file, String cloudFolderName, String containerName) {
<span class="fc" id="L1304">        ApiResponse response = ProjectUtil.createDefaultResponse(Constants.UPLOAD_FILE);</span>
        try {
<span class="fc" id="L1306">            String objectKey = cloudFolderName + &quot;/&quot; + file.getName();</span>
<span class="fc" id="L1307">            String url = storageService.upload(containerName, file.getAbsolutePath(),</span>
<span class="fc" id="L1308">                    objectKey, Option.apply(false), Option.apply(1), Option.apply(5), Option.empty());</span>
<span class="fc" id="L1309">            Map&lt;String, String&gt; uploadedFile = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1310">            uploadedFile.put(Constants.NAME, file.getName());</span>
<span class="fc" id="L1311">            uploadedFile.put(Constants.URL, url);</span>
<span class="fc" id="L1312">            response.getResult().putAll(uploadedFile);</span>
<span class="fc" id="L1313">            return response;</span>
<span class="fc" id="L1314">        } catch (Exception e) {</span>
<span class="fc" id="L1315">            log.error(&quot;Failed to upload file. Exception: &quot;, e);</span>
<span class="fc" id="L1316">            response.getParams().setStatus(Constants.FAILED);</span>
<span class="fc" id="L1317">            response.getParams().setErrMsg(&quot;Failed to upload file. Exception: &quot; + e.getMessage());</span>
<span class="fc" id="L1318">            response.setResponseCode(HttpStatus.INTERNAL_SERVER_ERROR);</span>
<span class="fc" id="L1319">            return response;</span>
        }
    }

    private void updateMetricsDbOperation(String apiName, String dbType, String operationType, long time) {
<span class="fc bfc" id="L1324" title="All 2 branches covered.">        if (ApiMetricsTracker.isTrackingEnabled()) {</span>
<span class="fc" id="L1325">            ApiMetricsTracker.recordDbOperation(apiName, dbType, operationType, System.currentTimeMillis() - time);</span>
        }
<span class="fc" id="L1327">    }</span>

    private void updateMetricsApiCall(String apiName) {
<span class="fc bfc" id="L1330" title="All 2 branches covered.">        if (ApiMetricsTracker.isTrackingEnabled()) {</span>
<span class="fc" id="L1331">            ApiMetricsTracker.recordApiCall(apiName);</span>
        }
<span class="fc" id="L1333">    }</span>

    private boolean validateCommunityId(String communityId) {
<span class="fc" id="L1336">        Optional&lt;CommunityEntity&gt; communityEntityOptional = communityEngagementRepository.findByCommunityIdAndIsActive(communityId, true);</span>
<span class="fc bfc" id="L1337" title="All 2 branches covered.">        if (communityEntityOptional.isPresent()) {</span>
<span class="fc" id="L1338">            return true;</span>
        }
<span class="fc" id="L1340">        return false;</span>
    }

    @Override
    public ApiResponse updateAnswerPost(JsonNode answerPostData, String token) {
<span class="fc" id="L1345">        log.info(&quot;DiscussionService::updateAnswerPost:updating answerPost&quot;);</span>
<span class="fc" id="L1346">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;discussion.updateAnswerPost&quot;);</span>
<span class="fc" id="L1347">        payloadValidation.validatePayload(Constants.ANSWER_POST_UPDATE_VALIDATION_SCHEMA, answerPostData);</span>
<span class="fc" id="L1348">        String userId = accessTokenValidator.verifyUserToken(token);</span>
<span class="pc bpc" id="L1349" title="1 of 4 branches missed.">        if (StringUtils.isBlank(userId) || userId.equals(Constants.UNAUTHORIZED)) {</span>
<span class="fc" id="L1350">            response.getParams().setErrMsg(Constants.INVALID_AUTH_TOKEN);</span>
<span class="fc" id="L1351">            response.setResponseCode(HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L1352">            return response;</span>
        }
<span class="fc" id="L1354">        updateMetricsApiCall(Constants.DISCUSSION_ANSWER_POST);</span>
<span class="fc" id="L1355">        long redisTimer = System.currentTimeMillis();</span>
<span class="fc" id="L1356">        DiscussionEntity discussionEntity = discussionRepository.findById(answerPostData.get(Constants.ANSWER_POST_ID).asText()).orElse(null);</span>
<span class="fc" id="L1357">        updateMetricsDbOperation(Constants.DISCUSSION_ANSWER_POST, Constants.POSTGRES, Constants.READ, redisTimer);</span>
<span class="pc bpc" id="L1358" title="1 of 4 branches missed.">        if (discussionEntity == null || !discussionEntity.getIsActive()) {</span>
<span class="fc" id="L1359">            return ProjectUtil.returnErrorMsg(Constants.INVALID_DISCUSSION_ID, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }
<span class="fc" id="L1361">        ObjectNode data = (ObjectNode) discussionEntity.getData();</span>
<span class="fc" id="L1362">        String type = data.get(Constants.TYPE).asText();</span>
<span class="fc bfc" id="L1363" title="All 2 branches covered.">        if (!type.equals(Constants.ANSWER_POST)) {</span>
<span class="fc" id="L1364">            return ProjectUtil.returnErrorMsg(Constants.INVALID_ANSWER_POST_ID, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }
<span class="fc bfc" id="L1366" title="All 2 branches covered.">        if (data.get(Constants.STATUS).asText().equals(Constants.SUSPENDED)) {</span>
<span class="fc" id="L1367">            return ProjectUtil.returnErrorMsg(Constants.DISCUSSION_SUSPENDED, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }

        try {
<span class="fc" id="L1371">            ObjectNode answerPostDataNode = (ObjectNode) answerPostData;</span>
<span class="fc" id="L1372">            Set&lt;String&gt; existingMentionedUserIds = new HashSet&lt;&gt;();</span>
<span class="fc" id="L1373">            data.withArray(MENTIONED_USERS).forEach(userNode -&gt; {</span>
<span class="nc" id="L1374">                String userid = userNode.path(USER_ID_RQST).asText(null);</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">                if (StringUtils.isNotBlank(userid)) existingMentionedUserIds.add(userid);</span>
<span class="nc" id="L1376">            });</span>
<span class="fc" id="L1377">            Set&lt;String&gt; seenUserIdsInRequest = new HashSet&lt;&gt;();</span>
<span class="fc" id="L1378">            List&lt;String&gt; newlyAddedUserIds = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1379">            ArrayNode uniqueMentionedUsers = objectMapper.createArrayNode();</span>
<span class="fc" id="L1380">            JsonNode incomingMentionedUsers = answerPostData.path(MENTIONED_USERS);</span>
<span class="pc bpc" id="L1381" title="1 of 2 branches missed.">            if (incomingMentionedUsers.isArray()) {</span>
<span class="nc bnc" id="L1382" title="All 2 branches missed.">                for (JsonNode userNode : incomingMentionedUsers) {</span>
<span class="nc" id="L1383">                    String userid = userNode.path(USER_ID_RQST).asText(null);</span>
<span class="nc bnc" id="L1384" title="All 4 branches missed.">                    if (StringUtils.isNotBlank(userid) &amp;&amp; seenUserIdsInRequest.add(userid)) {</span>
<span class="nc" id="L1385">                        uniqueMentionedUsers.add(userNode);</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">                        if (!existingMentionedUserIds.contains(userid)) {</span>
<span class="nc" id="L1387">                            newlyAddedUserIds.add(userid);</span>
                        }
                    }
<span class="nc" id="L1390">                }</span>
            }
<span class="fc" id="L1392">            answerPostDataNode.set(MENTIONED_USERS, uniqueMentionedUsers);</span>

<span class="fc" id="L1394">            answerPostDataNode.remove(Constants.ANSWER_POST_ID);</span>

<span class="pc bpc" id="L1396" title="1 of 4 branches missed.">            if (!answerPostDataNode.has(Constants.IS_INITIAL_UPLOAD) || !answerPostDataNode.get(Constants.IS_INITIAL_UPLOAD).asBoolean()) {</span>
<span class="fc" id="L1397">                Timestamp currentTime = new Timestamp(System.currentTimeMillis());</span>
<span class="fc" id="L1398">                answerPostDataNode.put(Constants.UPDATED_ON, getFormattedCurrentTime(currentTime));</span>
<span class="fc" id="L1399">                discussionEntity.setUpdatedOn(currentTime);</span>
            }
<span class="fc" id="L1401">            data.setAll(answerPostDataNode);</span>
<span class="fc" id="L1402">            discussionEntity.setData(data);</span>
<span class="fc" id="L1403">            discussionEntity.setIsProfane(false);</span>
<span class="fc" id="L1404">            long timer = System.currentTimeMillis();</span>
<span class="fc" id="L1405">            discussionRepository.save(discussionEntity);</span>
<span class="fc" id="L1406">            updateMetricsDbOperation(Constants.DISCUSSION_ANSWER_POST, Constants.POSTGRES, Constants.UPDATE, timer);</span>

<span class="fc" id="L1408">            ObjectNode jsonNode = objectMapper.createObjectNode();</span>
<span class="fc" id="L1409">            jsonNode.setAll(data);</span>
<span class="fc" id="L1410">            Map&lt;String, Object&gt; discussionAnswerPostDetailMap = objectMapper.convertValue(jsonNode, Map.class);</span>
<span class="pc bpc" id="L1411" title="1 of 2 branches missed.">            if(MapUtils.isNotEmpty(discussionAnswerPostDetailMap)) {</span>
<span class="nc" id="L1412">                discussionAnswerPostDetailMap.put(IS_PROFANE, false);</span>
            }
<span class="fc" id="L1414">            esUtilService.updateDocument(cbServerProperties.getDiscussionEntity(), discussionEntity.getDiscussionId(), discussionAnswerPostDetailMap, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="fc" id="L1415">            cacheService.putCache(Constants.DISCUSSION_CACHE_PREFIX + String.valueOf(discussionEntity.getDiscussionId()), jsonNode);</span>
<span class="fc" id="L1416">            redisTemplate.opsForValue()</span>
<span class="fc" id="L1417">                    .getAndDelete(DiscussionServiceUtil.generateRedisJwtTokenKey(createSearchCriteriaWithDefaults(</span>
<span class="fc" id="L1418">                            data.get(Constants.PARENT_DISCUSSION_ID).asText(),</span>
<span class="fc" id="L1419">                            data.get(Constants.COMMUNITY_ID).asText(),</span>
                            Constants.ANSWER_POST)));
<span class="fc" id="L1421">            log.info(&quot;AnswerPost updated successfully&quot;);</span>
            try {
<span class="pc bpc" id="L1423" title="1 of 2 branches missed.">                if (CollectionUtils.isNotEmpty(newlyAddedUserIds)) {</span>
<span class="nc" id="L1424">                    Map&lt;String, Object&gt; notificationData = Map.of(</span>
<span class="nc" id="L1425">                            Constants.COMMUNITY_ID, data.get(Constants.COMMUNITY_ID).asText(),</span>
<span class="nc" id="L1426">                            Constants.DISCUSSION_ID, discussionEntity.getDiscussionId()</span>
                    );
<span class="nc" id="L1428">                    String firstName = helperMethodService.fetchUserFirstName(userId);</span>
<span class="nc" id="L1429">                    notificationTriggerService.triggerNotification(TAGGED_COMMENT, ENGAGEMENT, newlyAddedUserIds, TITLE, firstName, notificationData);</span>
                }
<span class="nc" id="L1431">            } catch (Exception e) {</span>
<span class="nc" id="L1432">                log.error(&quot;Error while triggering notification&quot;, e);</span>
<span class="fc" id="L1433">            }</span>
<span class="pc bpc" id="L1434" title="1 of 2 branches missed.">            if(MapUtils.isNotEmpty(discussionAnswerPostDetailMap)) {</span>
<span class="nc" id="L1435">                discussionAnswerPostDetailMap.remove(IS_PROFANE);</span>
<span class="nc" id="L1436">                discussionAnswerPostDetailMap.remove(Constants.PROFANITY_RESPONSE);</span>
            }
<span class="fc" id="L1438">            response.setResponseCode(HttpStatus.OK);</span>
<span class="fc" id="L1439">            response.getParams().setStatus(Constants.SUCCESS);</span>
<span class="fc" id="L1440">            response.setResult(discussionAnswerPostDetailMap);</span>
<span class="pc bpc" id="L1441" title="1 of 2 branches missed.">            if (answerPostData.hasNonNull(Constants.LANGUAGE)) {</span>
<span class="nc" id="L1442">                ((ObjectNode) answerPostData).put(Constants.TYPE, data.get(Constants.TYPE).asText());</span>
<span class="nc" id="L1443">                profanityCheckService.processProfanityCheck(discussionEntity.getDiscussionId(), (ObjectNode) answerPostData);</span>
            }
<span class="fc" id="L1445">        } catch (Exception e) {</span>
<span class="fc" id="L1446">            log.error(&quot;Failed to update AnswerPost: {}&quot;, e.getMessage(), e);</span>
<span class="fc" id="L1447">            DiscussionServiceUtil.createErrorResponse(response, Constants.FAILED_TO_UPDATE_ANSWER_POST, HttpStatus.INTERNAL_SERVER_ERROR, Constants.FAILED);</span>
<span class="fc" id="L1448">            return response;</span>
<span class="fc" id="L1449">        }</span>
<span class="fc" id="L1450">        return response;</span>
    }

    @Override
    public ApiResponse bookmarkDiscussion(String token, String communityId, String discussionId) {
<span class="fc" id="L1455">        log.info(&quot;DiscussionService::bookmarkDiscussion: Bookmarking discussion&quot;);</span>
<span class="fc" id="L1456">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;discussion.bookmarkDiscussion&quot;);</span>
<span class="fc bfc" id="L1457" title="All 2 branches covered.">        if (StringUtils.isBlank(discussionId)) {</span>
<span class="fc" id="L1458">            return ProjectUtil.returnErrorMsg(Constants.INVALID_DISCUSSION_ID, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }

<span class="fc bfc" id="L1461" title="All 2 branches covered.">        if (StringUtils.isBlank(communityId)) {</span>
<span class="fc" id="L1462">            return ProjectUtil.returnErrorMsg(Constants.INVALID_COMMUNITY_ID, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }
<span class="fc" id="L1464">        String userId = accessTokenValidator.verifyUserToken(token);</span>
<span class="pc bpc" id="L1465" title="1 of 4 branches missed.">        if (StringUtils.isBlank(userId) || Constants.UNAUTHORIZED.equals(userId)) {</span>
<span class="fc" id="L1466">            return ProjectUtil.returnErrorMsg(Constants.INVALID_AUTH_TOKEN, HttpStatus.UNAUTHORIZED, response, Constants.FAILED);</span>
        }

        try {
<span class="fc" id="L1470">            Optional&lt;DiscussionEntity&gt; discussionDbData = discussionRepository.findById(discussionId);</span>
<span class="fc bfc" id="L1471" title="All 2 branches covered.">            if (!discussionDbData.isPresent()) {</span>
<span class="fc" id="L1472">                return ProjectUtil.returnErrorMsg(Constants.DISCUSSION_NOT_FOUND, HttpStatus.NOT_FOUND, response, Constants.FAILED);</span>
            }
<span class="fc" id="L1474">            DiscussionEntity discussionEntity = discussionDbData.get();</span>
<span class="fc bfc" id="L1475" title="All 2 branches covered.">            if (!discussionEntity.getIsActive()) {</span>
<span class="fc" id="L1476">                return ProjectUtil.returnErrorMsg(Constants.DISCUSSION_IS_INACTIVE, HttpStatus.CONFLICT, response, Constants.FAILED);</span>
            }

<span class="fc" id="L1479">            String bookMarkedCommunityId = discussionEntity.getData().get(Constants.COMMUNITY_ID).asText();</span>
<span class="fc bfc" id="L1480" title="All 2 branches covered.">            if (!bookMarkedCommunityId.equals(communityId)) {</span>
<span class="fc" id="L1481">                return ProjectUtil.returnErrorMsg(Constants.INVALID_COMMUNITY_ID, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
            }

<span class="fc" id="L1484">            Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1485">            properties.put(Constants.USERID, userId);</span>
<span class="fc" id="L1486">            properties.put(Constants.COMMUNITY_ID, communityId);</span>
<span class="fc" id="L1487">            properties.put(Constants.DISCUSSION_ID, discussionId);</span>

            // Check if the bookmark already exists
<span class="fc" id="L1490">            List&lt;Map&lt;String, Object&gt;&gt; existingBookmarks = cassandraOperation.getRecordsByPropertiesWithoutFiltering(</span>
<span class="fc" id="L1491">                    Constants.KEYSPACE_SUNBIRD, Constants.DISCUSSION_BOOKMARKS, properties, Arrays.asList(Constants.STATUS), null);</span>

<span class="pc bpc" id="L1493" title="1 of 4 branches missed.">            if (!existingBookmarks.isEmpty() &amp;&amp; (boolean) existingBookmarks.get(0).get(Constants.STATUS)) {</span>
<span class="fc" id="L1494">                return ProjectUtil.returnErrorMsg(Constants.ALREADY_BOOKMARKED, HttpStatus.ALREADY_REPORTED, response, Constants.FAILED);</span>
            }

            // Insert the new bookmark
<span class="fc" id="L1498">            properties.put(Constants.CREATED_ON, Instant.now());</span>
<span class="fc" id="L1499">            properties.put(Constants.STATUS, true);</span>
<span class="fc" id="L1500">            cassandraOperation.insertRecord(Constants.KEYSPACE_SUNBIRD, Constants.DISCUSSION_BOOKMARKS, properties);</span>
<span class="fc" id="L1501">            cacheService.deleteCache(Constants.DISCUSSION_CACHE_PREFIX + Constants.COMMUNITY + communityId + userId);</span>
<span class="fc" id="L1502">            Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1503">            map.put(Constants.CREATED_ON, properties.get(Constants.CREATED_ON));</span>
<span class="fc" id="L1504">            map.put(Constants.COMMUNITY_ID, communityId);</span>
<span class="fc" id="L1505">            map.put(Constants.DISCUSSION_ID, discussionId);</span>
<span class="fc" id="L1506">            response.setResult(map);</span>
<span class="fc" id="L1507">            return response;</span>
<span class="nc" id="L1508">        } catch (Exception e) {</span>
<span class="nc" id="L1509">            log.error(&quot;DiscussionService::bookmarkDiscussion: Failed to bookmark discussion&quot;, e);</span>
<span class="nc" id="L1510">            return ProjectUtil.returnErrorMsg(Constants.DISCUSSION_BOOKMARK_FAILED, HttpStatus.INTERNAL_SERVER_ERROR, response, Constants.FAILED);</span>
        }
    }

    public ApiResponse unBookmarkDiscussion(String communityId, String discussionId, String token) {
<span class="fc" id="L1515">        log.info(&quot;DiscussionService::unBookmarkDiscussion: UnBookmarking discussion&quot;);</span>
<span class="fc" id="L1516">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;discussion.unBookmarkDiscussion&quot;);</span>
<span class="fc bfc" id="L1517" title="All 2 branches covered.">        if (StringUtils.isBlank(discussionId)) {</span>
<span class="fc" id="L1518">            return ProjectUtil.returnErrorMsg(Constants.INVALID_DISCUSSION_ID, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }

<span class="fc bfc" id="L1521" title="All 2 branches covered.">        if (StringUtils.isBlank(communityId)) {</span>
<span class="fc" id="L1522">            return ProjectUtil.returnErrorMsg(Constants.INVALID_COMMUNITY_ID, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }
<span class="fc" id="L1524">        String userId = accessTokenValidator.verifyUserToken(token);</span>
<span class="pc bpc" id="L1525" title="1 of 4 branches missed.">        if (StringUtils.isBlank(userId) || Constants.UNAUTHORIZED.equals(userId)) {</span>
<span class="fc" id="L1526">            return ProjectUtil.returnErrorMsg(Constants.INVALID_AUTH_TOKEN, HttpStatus.UNAUTHORIZED, response, Constants.FAILED);</span>
        }

<span class="fc" id="L1529">        Map&lt;String, Object&gt; compositeKeys = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1530">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1531">        compositeKeys.put(Constants.COMMUNITY_ID, communityId);</span>
<span class="fc" id="L1532">        compositeKeys.put(Constants.DISCUSSION_ID, discussionId);</span>
<span class="fc" id="L1533">        compositeKeys.put(Constants.USERID, userId);</span>
<span class="fc" id="L1534">        properties.put(Constants.STATUS, false);</span>

        try {
<span class="fc" id="L1537">            cassandraOperation.updateRecordByCompositeKey(Constants.KEYSPACE_SUNBIRD, Constants.DISCUSSION_BOOKMARKS, properties, compositeKeys);</span>
<span class="fc" id="L1538">            cacheService.deleteCache(Constants.DISCUSSION_CACHE_PREFIX + Constants.COMMUNITY + communityId + userId);</span>
<span class="fc" id="L1539">            return response;</span>
<span class="nc" id="L1540">        } catch (Exception e) {</span>
<span class="nc" id="L1541">            log.error(&quot;DiscussionService::unBookmarkDiscussion: Failed to unBookmark discussion&quot;, e);</span>
<span class="nc" id="L1542">            return ProjectUtil.returnErrorMsg(Constants.DISCUSSION_UN_BOOKMARK_FAILED, HttpStatus.INTERNAL_SERVER_ERROR, response, Constants.FAILED);</span>
        }
    }

    @Override
    public ApiResponse getBookmarkedDiscussions(String token, Map&lt;String, Object&gt; requestData) {
<span class="fc" id="L1548">        log.info(&quot;DiscussionService::getBookmarkedDiscussions: Fetching bookmarked discussions&quot;);</span>
<span class="fc" id="L1549">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;discussion.getBookmarkedDiscussions&quot;);</span>
<span class="fc" id="L1550">        String errorMsg = validateGetBookmarkedDiscussions(requestData);</span>

<span class="fc bfc" id="L1552" title="All 2 branches covered.">        if (StringUtils.isNotBlank(errorMsg)) {</span>
<span class="fc" id="L1553">            return ProjectUtil.returnErrorMsg(errorMsg, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }
<span class="fc" id="L1555">        String userId = accessTokenValidator.verifyUserToken(token);</span>
<span class="pc bpc" id="L1556" title="1 of 4 branches missed.">        if (StringUtils.isBlank(userId) || Constants.UNAUTHORIZED.equals(userId)) {</span>
<span class="fc" id="L1557">            return ProjectUtil.returnErrorMsg(Constants.INVALID_AUTH_TOKEN, HttpStatus.UNAUTHORIZED, response, Constants.FAILED);</span>
        }
        try {
<span class="fc" id="L1560">            List&lt;String&gt; cachedKeys = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1561">            String cachedJson = cacheService.getCache(Constants.DISCUSSION_CACHE_PREFIX + Constants.COMMUNITY + requestData.get(Constants.COMMUNITY_ID) + userId);</span>
<span class="fc bfc" id="L1562" title="All 2 branches covered.">            if (StringUtils.isNotBlank(cachedJson)) {</span>
<span class="fc" id="L1563">                cachedKeys = objectMapper.readValue(cachedJson, new TypeReference&lt;List&lt;String&gt;&gt;() {</span>
                });
            } else {
<span class="fc" id="L1566">                Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1567">                properties.put(Constants.USERID, userId);</span>
<span class="fc" id="L1568">                properties.put(Constants.COMMUNITY_ID, requestData.get(Constants.COMMUNITY_ID));</span>
<span class="fc" id="L1569">                List&lt;Map&lt;String, Object&gt;&gt; bookmarkedDiscussions = cassandraOperation.getRecordsByPropertiesWithoutFiltering(Constants.KEYSPACE_SUNBIRD, Constants.DISCUSSION_BOOKMARKS, properties, Arrays.asList(Constants.DISCUSSION_ID, Constants.STATUS), null);</span>
<span class="pc bpc" id="L1570" title="1 of 2 branches missed.">                if (bookmarkedDiscussions.isEmpty()) {</span>
<span class="fc" id="L1571">                    return ProjectUtil.returnErrorMsg(Constants.NO_DISCUSSIONS_FOUND, HttpStatus.OK, response, Constants.SUCCESS);</span>
                }
<span class="nc bnc" id="L1573" title="All 2 branches missed.">                for (Map&lt;String, Object&gt; bookmarkedDiscussion : bookmarkedDiscussions) {</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">                    if (Boolean.TRUE.equals(bookmarkedDiscussion.get(Constants.STATUS))) {</span>
<span class="nc" id="L1575">                        cachedKeys.add((String) bookmarkedDiscussion.get(Constants.DISCUSSION_ID_KEY));</span>
                    }
<span class="nc" id="L1577">                }</span>
<span class="nc bnc" id="L1578" title="All 2 branches missed.">                if (cachedKeys.isEmpty()) {</span>
<span class="nc" id="L1579">                    return ProjectUtil.returnErrorMsg(Constants.NO_DISCUSSIONS_FOUND, HttpStatus.OK, response, Constants.SUCCESS);</span>
                }
<span class="nc" id="L1581">                cacheService.putCache(Constants.DISCUSSION_CACHE_PREFIX + Constants.COMMUNITY + requestData.get(Constants.COMMUNITY_ID) + userId, cachedKeys);</span>
            }

<span class="fc" id="L1584">            SearchCriteria searchCriteria = new SearchCriteria();</span>
<span class="fc" id="L1585">            HashMap&lt;String, Object&gt; filterCriteria = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1586">            filterCriteria.put(Constants.DISCUSSION_ID, cachedKeys);</span>
<span class="fc" id="L1587">            searchCriteria.setFilterCriteriaMap(filterCriteria);</span>
<span class="fc" id="L1588">            searchCriteria.setPageNumber((int) requestData.get(Constants.PAGE));</span>
<span class="fc" id="L1589">            searchCriteria.setPageSize((int) requestData.get(Constants.PAGE_SIZE));</span>
<span class="fc" id="L1590">            searchCriteria.setOrderDirection(Constants.DESC);</span>
<span class="fc" id="L1591">            searchCriteria.setOrderBy(Constants.CREATED_ON);</span>
<span class="fc" id="L1592">            searchCriteria.getFilterCriteriaMap().put(IS_PROFANE, false);</span>
<span class="pc bpc" id="L1593" title="2 of 4 branches missed.">            if (requestData.containsKey(Constants.SEARCH_STRING) &amp;&amp; StringUtils.isNotBlank((String) requestData.get(Constants.SEARCH_STRING))) {</span>
<span class="fc bfc" id="L1594" title="All 2 branches covered.">                if (((String) requestData.get(Constants.SEARCH_STRING)).length() &lt; 3) {</span>
<span class="fc" id="L1595">                    DiscussionServiceUtil.createErrorResponse(response, Constants.MINIMUM_CHARACTERS_NEEDED, HttpStatus.BAD_REQUEST, Constants.FAILED_CONST);</span>
<span class="fc" id="L1596">                    return response;</span>
                }
<span class="fc" id="L1598">                searchCriteria.setSearchString((String) requestData.get(Constants.SEARCH_STRING));</span>
            }

<span class="fc" id="L1601">            SearchResult searchResult = redisTemplate.opsForValue().get(DiscussionServiceUtil.generateRedisJwtTokenKey(searchCriteria));</span>
<span class="pc bpc" id="L1602" title="1 of 2 branches missed.">            if (searchResult == null) {</span>
<span class="fc" id="L1603">                searchResult = esUtilService.searchDocuments(cbServerProperties.getDiscussionEntity(), searchCriteria, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="nc" id="L1604">                List&lt;Map&lt;String, Object&gt;&gt; data = searchResult.getData();</span>
<span class="nc" id="L1605">                fetchAndEnhanceDiscussions(data, false);</span>
<span class="nc" id="L1606">                searchResult.setData(data);</span>
<span class="nc" id="L1607">                redisTemplate.opsForValue().set(DiscussionServiceUtil.generateRedisJwtTokenKey(searchCriteria), searchResult, cbServerProperties.getSearchResultRedisTtl(), TimeUnit.SECONDS);</span>
            }

<span class="nc" id="L1610">            HashMap&lt;String, Object&gt; result = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1611">            result.put(Constants.SEARCH_RESULTS, searchResult);</span>
<span class="nc" id="L1612">            response.setResult(result);</span>
<span class="nc" id="L1613">            return response;</span>
<span class="fc" id="L1614">        } catch (Exception e) {</span>
<span class="fc" id="L1615">            log.error(&quot;DiscussionService::getBookmarkedDiscussions: Failed to fetch bookmarked discussions&quot;, e);</span>
<span class="fc" id="L1616">            return ProjectUtil.returnErrorMsg(Constants.DISCUSSION_BOOKMARK_FETCH_FAILED, HttpStatus.INTERNAL_SERVER_ERROR, response, Constants.FAILED);</span>
        }
    }

    private String validateGetBookmarkedDiscussions(Map&lt;String, Object&gt; requestData) {
<span class="pc bpc" id="L1621" title="1 of 2 branches missed.">        if (requestData == null) {</span>
<span class="nc" id="L1622">            return Constants.MISSING_REQUEST_DATA;</span>
        }

<span class="fc" id="L1625">        StringBuffer errorMsg = new StringBuffer();</span>
<span class="fc" id="L1626">        List&lt;String&gt; errList = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L1628" title="1 of 4 branches missed.">        if (!requestData.containsKey(Constants.COMMUNITY_ID) &amp;&amp; StringUtils.isBlank((String) requestData.get(Constants.COMMUNITY_ID))) {</span>
<span class="fc" id="L1629">            errList.add(Constants.COMMUNITY_ID);</span>
        }
<span class="pc bpc" id="L1631" title="1 of 4 branches missed.">        if (!requestData.containsKey(Constants.PAGE) || !(requestData.get(Constants.PAGE) instanceof Integer)) {</span>
<span class="fc" id="L1632">            errList.add(Constants.PAGE);</span>
        }
<span class="pc bpc" id="L1634" title="1 of 4 branches missed.">        if (!requestData.containsKey(Constants.PAGE_SIZE) || !(requestData.get(Constants.PAGE_SIZE) instanceof Integer)) {</span>
<span class="fc" id="L1635">            errList.add(Constants.PAGE_SIZE);</span>
        }
<span class="fc bfc" id="L1637" title="All 2 branches covered.">        if (!errList.isEmpty()) {</span>
<span class="fc" id="L1638">            errorMsg.append(&quot;Failed Due To Missing Params - &quot;).append(errList).append(&quot;.&quot;);</span>
        }
<span class="fc" id="L1640">        return errorMsg.toString();</span>
    }

    private void fetchAndEnhanceDiscussions(List&lt;Map&lt;String, Object&gt;&gt; discussions, boolean isAnswerPost) {
<span class="fc" id="L1644">        Map&lt;String, String&gt; discussionToCreatedByMap = discussions.stream()</span>
<span class="fc" id="L1645">                .collect(Collectors.toMap(</span>
<span class="fc" id="L1646">                        discussion -&gt; discussion.get(Constants.DISCUSSION_ID).toString(),</span>
<span class="fc" id="L1647">                        discussion -&gt; discussion.get(Constants.CREATED_BY).toString()));</span>

<span class="fc" id="L1649">        Map&lt;String, List&lt;String&gt;&gt; discussionToUserTagMap = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L1650" title="1 of 2 branches missed.">        if (isAnswerPost) {</span>
<span class="nc" id="L1651">            discussionToUserTagMap.putAll(discussions.stream()</span>
<span class="nc" id="L1652">                    .filter(discussion -&gt; discussion.containsKey(Constants.TAGGED_USER))</span>
<span class="nc" id="L1653">                    .collect(Collectors.toMap(</span>
<span class="nc" id="L1654">                            discussion -&gt; discussion.get(Constants.DISCUSSION_ID).toString(),</span>
<span class="nc" id="L1655">                            discussion -&gt; (List&lt;String&gt;) discussion.get(Constants.TAGGED_USER))));</span>
        }

<span class="fc" id="L1658">        Set&lt;String&gt; createdByIds = new HashSet&lt;&gt;(discussionToCreatedByMap.values());</span>
<span class="fc" id="L1659">        Set&lt;String&gt; userTagIds = new HashSet&lt;&gt;();</span>
<span class="pc bpc" id="L1660" title="1 of 2 branches missed.">        if (!discussionToUserTagMap.isEmpty()) {</span>
<span class="nc" id="L1661">            userTagIds = discussionToUserTagMap.values().stream()</span>
<span class="nc" id="L1662">                    .flatMap(Collection::stream)</span>
<span class="nc" id="L1663">                    .collect(Collectors.toSet());</span>
        }
<span class="fc" id="L1665">        Set&lt;String&gt; allUserIds = new HashSet&lt;&gt;();</span>
<span class="fc" id="L1666">        allUserIds.addAll(createdByIds);</span>
<span class="fc" id="L1667">        allUserIds.addAll(userTagIds);</span>

<span class="fc" id="L1669">        long userDataRedisTime = System.currentTimeMillis();</span>
<span class="pc" id="L1670">        List&lt;Object&gt; redisResults = fetchDataForKeys(</span>
<span class="fc" id="L1671">                allUserIds.stream().map(id -&gt; Constants.USER_PREFIX + id).collect(Collectors.toList()), true</span>
        );
<span class="nc" id="L1673">        updateMetricsDbOperation(Constants.DISCUSSION_SEARCH, Constants.REDIS, Constants.READ, userDataRedisTime);</span>
<span class="nc" id="L1674">        Map&lt;String, Object&gt; userDetailsMap = redisResults.stream()</span>
<span class="nc" id="L1675">                .map(user -&gt; (Map&lt;String, Object&gt;) user)</span>
<span class="nc" id="L1676">                .collect(Collectors.toMap(</span>
<span class="nc" id="L1677">                        user -&gt; user.get(Constants.USER_ID_KEY).toString(),</span>
<span class="nc" id="L1678">                        user -&gt; user));</span>

<span class="nc" id="L1680">        List&lt;String&gt; missingUserIds = allUserIds.stream()</span>
<span class="nc bnc" id="L1681" title="All 2 branches missed.">                .filter(id -&gt; !userDetailsMap.containsKey(id))</span>
<span class="nc" id="L1682">                .collect(Collectors.toList());</span>

<span class="nc bnc" id="L1684" title="All 2 branches missed.">        if (!missingUserIds.isEmpty()) {</span>
<span class="nc" id="L1685">            List&lt;Object&gt; cassandraResults = fetchUserFromPrimary(missingUserIds);</span>
<span class="nc" id="L1686">            userDetailsMap.putAll(cassandraResults.stream()</span>
<span class="nc" id="L1687">                    .map(user -&gt; (Map&lt;String, Object&gt;) user)</span>
<span class="nc" id="L1688">                    .collect(Collectors.toMap(</span>
<span class="nc" id="L1689">                            user -&gt; user.get(Constants.USER_ID_KEY).toString(),</span>
<span class="nc" id="L1690">                            user -&gt; user)));</span>
        }

<span class="nc" id="L1693">        discussions.forEach(discussion -&gt; {</span>
<span class="nc" id="L1694">            String discussionId = discussion.get(Constants.DISCUSSION_ID).toString();</span>
<span class="nc" id="L1695">            String createdById = discussionToCreatedByMap.get(discussionId);</span>
<span class="nc" id="L1696">            List&lt;String&gt; userTagIdsList = discussionToUserTagMap.get(discussionId);</span>
<span class="nc bnc" id="L1697" title="All 4 branches missed.">            boolean hasCreatedBy = createdById != null &amp;&amp; userDetailsMap.containsKey(createdById);</span>
<span class="nc bnc" id="L1698" title="All 2 branches missed.">            if (hasCreatedBy) {</span>
<span class="nc" id="L1699">                Map&lt;String, Object&gt; userData = (Map&lt;String, Object&gt;) userDetailsMap.get(createdById);</span>
<span class="nc" id="L1700">                Object designationObj = userData.get(DESIGNATION_KEY);</span>
<span class="nc bnc" id="L1701" title="All 2 branches missed.">                String designationStr = designationObj != null ? designationObj.toString() : &quot;&quot;;</span>
<span class="nc bnc" id="L1702" title="All 4 branches missed.">                if (designationStr.isBlank() || &quot;null&quot;.equalsIgnoreCase(designationStr)) {</span>
<span class="nc" id="L1703">                    userData.put(DESIGNATION_KEY, &quot;&quot;);</span>
                }
<span class="nc" id="L1705">                discussion.put(Constants.CREATED_BY, userDetailsMap.get(createdById));</span>
            }
<span class="nc bnc" id="L1707" title="All 6 branches missed.">            if (isAnswerPost &amp;&amp; userTagIdsList != null &amp;&amp; !userTagIdsList.isEmpty()) {</span>
<span class="nc" id="L1708">                List&lt;Object&gt; userTags = userTagIdsList.stream()</span>
<span class="nc" id="L1709">                        .filter(userDetailsMap::containsKey)</span>
<span class="nc" id="L1710">                        .map(userDetailsMap::get)</span>
<span class="nc" id="L1711">                        .collect(Collectors.toList());</span>
<span class="nc" id="L1712">                discussion.put(Constants.TAGGED_USER, userTags);</span>
            }
<span class="nc" id="L1714">        });</span>
<span class="nc" id="L1715">    }</span>

    @Override
    public ApiResponse searchDiscussionByCommunity(Map&lt;String, Object&gt; searchData) {
<span class="fc" id="L1719">        log.info(&quot;DiscussionServiceImpl::searchDiscussionByCommunity&quot;);</span>
<span class="fc" id="L1720">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;search.discussion.by.community&quot;);</span>
<span class="fc" id="L1721">        String error = validateCommunitySearchRequest(searchData);</span>
<span class="fc bfc" id="L1722" title="All 2 branches covered.">        if (StringUtils.isNotEmpty(error)) {</span>
<span class="fc" id="L1723">            DiscussionServiceUtil.createErrorResponse(response, error, HttpStatus.BAD_REQUEST, Constants.FAILED_CONST);</span>
<span class="fc" id="L1724">            return response;</span>
        }

        try {
<span class="fc" id="L1728">            String cacheKey = Constants.DISCUSSION_CACHE_PREFIX + searchData.get(Constants.COMMUNITY_ID) + Constants.UNDER_SCORE + searchData.get(Constants.PAGE_NUMBER);</span>
<span class="fc" id="L1729">            SearchResult searchResult = redisTemplate.opsForValue().get(cacheKey);</span>

<span class="fc bfc" id="L1731" title="All 2 branches covered.">            if (searchResult != null) {</span>
<span class="fc" id="L1732">                log.info(&quot;DiscussionServiceImpl::searchDiscussionByCommunity: search result fetched from redis&quot;);</span>
<span class="fc" id="L1733">                response.getResult().put(Constants.SEARCH_RESULTS, searchResult);</span>
<span class="fc" id="L1734">                DiscussionServiceUtil.createSuccessResponse(response);</span>
<span class="fc" id="L1735">                return response;</span>
            }

<span class="fc" id="L1738">            SearchCriteria searchCriteria = getCriteria((int) searchData.get(Constants.PAGE_NUMBER), cbServerProperties.getDiscussionEsDefaultPageSize());</span>
<span class="fc" id="L1739">            Map&lt;String, Object&gt; filterCriteria = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1740">            filterCriteria.put(Constants.COMMUNITY_ID, searchData.get(Constants.COMMUNITY_ID));</span>
<span class="fc" id="L1741">            filterCriteria.put(Constants.TYPE, Constants.QUESTION);</span>
<span class="fc" id="L1742">            filterCriteria.put(Constants.STATUS, Arrays.asList(Constants.ACTIVE, Constants.REPORTED));</span>
<span class="fc" id="L1743">            filterCriteria.put(Constants.IS_ACTIVE, true);</span>
<span class="fc" id="L1744">            filterCriteria.put(IS_PROFANE, false);</span>
<span class="fc" id="L1745">            searchCriteria.getFilterCriteriaMap().putAll(filterCriteria);</span>
<span class="fc" id="L1746">            searchResult = esUtilService.searchDocuments(cbServerProperties.getDiscussionEntity(), searchCriteria, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="fc" id="L1747">            List&lt;Map&lt;String, Object&gt;&gt; discussions = searchResult.getData();</span>

<span class="pc bpc" id="L1749" title="2 of 4 branches missed.">            if (searchCriteria.getRequestedFields().contains(Constants.CREATED_BY) || searchCriteria.getRequestedFields().isEmpty()) {</span>
<span class="nc" id="L1750">                fetchAndEnhanceDiscussions(discussions, false);</span>
            }

<span class="nc" id="L1753">            searchResult.setData(discussions);</span>
<span class="nc" id="L1754">            redisTemplate.opsForValue().set(cacheKey, searchResult, cbServerProperties.getDiscussionFeedRedisTtl(), TimeUnit.SECONDS);</span>
<span class="nc" id="L1755">            response.getResult().put(Constants.SEARCH_RESULTS, searchResult);</span>
<span class="nc" id="L1756">            DiscussionServiceUtil.createSuccessResponse(response);</span>
<span class="nc" id="L1757">            return response;</span>
<span class="fc" id="L1758">        } catch (Exception e) {</span>
<span class="fc" id="L1759">            log.error(&quot;error while searching discussion by community: {} .&quot;, e.getMessage(), e);</span>
<span class="fc" id="L1760">            DiscussionServiceUtil.createErrorResponse(response, e.getMessage(), HttpStatus.INTERNAL_SERVER_ERROR, Constants.FAILED_CONST);</span>
<span class="fc" id="L1761">            return response;</span>
        }
    }

    private SearchCriteria getCriteria(int pageNumber, int pageSize) {
<span class="fc" id="L1766">        SearchCriteria searchCriteria = new SearchCriteria();</span>
<span class="fc" id="L1767">        searchCriteria.setPageNumber(pageNumber);</span>
<span class="fc" id="L1768">        searchCriteria.setPageSize(pageSize);</span>
<span class="fc" id="L1769">        searchCriteria.setOrderBy(Constants.CREATED_ON);</span>
<span class="fc" id="L1770">        searchCriteria.setOrderDirection(Constants.DESC);</span>
<span class="fc" id="L1771">        searchCriteria.setFilterCriteriaMap(new HashMap&lt;&gt;());</span>
<span class="fc" id="L1772">        searchCriteria.setRequestedFields(new ArrayList&lt;&gt;());</span>
<span class="fc" id="L1773">        return searchCriteria;</span>
    }

    private String validateCommunitySearchRequest(Map&lt;String, Object&gt; searchData) {

<span class="pc bpc" id="L1778" title="1 of 2 branches missed.">        if (searchData == null) {</span>
<span class="nc" id="L1779">            return Constants.MISSING_REQUEST_DATA;</span>
        }

<span class="fc" id="L1782">        StringBuffer errorMsg = new StringBuffer();</span>
<span class="fc" id="L1783">        List&lt;String&gt; errList = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L1785" title="1 of 4 branches missed.">        if (!searchData.containsKey(Constants.COMMUNITY_ID) || StringUtils.isBlank((String) searchData.get(Constants.COMMUNITY_ID))) {</span>
<span class="fc" id="L1786">            errList.add(Constants.COMMUNITY_ID);</span>
        }
<span class="pc bpc" id="L1788" title="1 of 4 branches missed.">        if (!searchData.containsKey(Constants.PAGE_NUMBER) || !(searchData.get(Constants.PAGE_NUMBER) instanceof Integer)) {</span>
<span class="fc" id="L1789">            errList.add(Constants.PAGE_NUMBER);</span>
        }
<span class="fc bfc" id="L1791" title="All 2 branches covered.">        if (!errList.isEmpty()) {</span>
<span class="fc" id="L1792">            errorMsg.append(&quot;Failed Due To Missing Params - &quot;).append(errList).append(&quot;.&quot;);</span>
        }
<span class="fc" id="L1794">        return errorMsg.toString();</span>
    }

    public void deleteCacheByCommunity(String prefix) {
<span class="fc" id="L1798">        String pattern = prefix + &quot;_*&quot;;</span>
<span class="fc" id="L1799">        Set&lt;String&gt; keys = redisTemplate.keys(pattern);</span>
<span class="pc bpc" id="L1800" title="1 of 2 branches missed.">        if (!keys.isEmpty()) {</span>
<span class="nc" id="L1801">            redisTemplate.delete(keys);</span>
<span class="nc" id="L1802">            log.info(&quot;Deleted cache keys: {}&quot;, keys);</span>
        } else {
<span class="fc" id="L1804">            log.info(&quot;No cache keys found for pattern: {}&quot;, pattern);</span>
        }
<span class="fc" id="L1806">    }</span>

    public void updateCacheForFirstFivePages(String communityId, boolean isDocumentType) {
<span class="fc" id="L1809">        SearchCriteria searchCriteria = getCriteria(0, 5 * cbServerProperties.getDiscussionEsDefaultPageSize());</span>
<span class="fc" id="L1810">        Map&lt;String, Object&gt; filterCriteria = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1811">        filterCriteria.put(Constants.COMMUNITY_ID, communityId);</span>
<span class="fc" id="L1812">        filterCriteria.put(Constants.TYPE, Constants.QUESTION);</span>
<span class="pc bpc" id="L1813" title="1 of 2 branches missed.">        if (isDocumentType) {</span>
<span class="nc" id="L1814">            filterCriteria.put(Constants.CATEGORY_TYPE, Arrays.asList(Constants.DOCUMENT));</span>
        }
<span class="fc" id="L1816">        filterCriteria.put(Constants.STATUS, Arrays.asList(Constants.ACTIVE, Constants.REPORTED));</span>
<span class="fc" id="L1817">        filterCriteria.put(Constants.IS_ACTIVE, true);</span>
<span class="fc" id="L1818">        filterCriteria.put(IS_PROFANE, false);</span>
<span class="fc" id="L1819">        searchCriteria.getFilterCriteriaMap().putAll(filterCriteria);</span>

        try {
<span class="fc" id="L1822">            SearchResult searchResult = esUtilService.searchDocuments(cbServerProperties.getDiscussionEntity(), searchCriteria, cbServerProperties.getElasticDiscussionJsonPath());</span>
<span class="nc" id="L1823">            List&lt;Map&lt;String, Object&gt;&gt; discussions = searchResult.getData();</span>

<span class="nc bnc" id="L1825" title="All 4 branches missed.">            if (searchCriteria.getRequestedFields().contains(Constants.CREATED_BY) || searchCriteria.getRequestedFields().isEmpty()) {</span>
<span class="nc" id="L1826">                fetchAndEnhanceDiscussions(discussions, false);</span>
            }

            String cacheKeyPrefix;
<span class="nc bnc" id="L1830" title="All 2 branches missed.">            if (isDocumentType) {</span>
<span class="nc" id="L1831">                cacheKeyPrefix = Constants.DISCUSSION_DOCUMENT_POST + communityId + Constants.UNDER_SCORE;</span>
            } else {
<span class="nc" id="L1833">                cacheKeyPrefix = Constants.DISCUSSION_CACHE_PREFIX + communityId + Constants.UNDER_SCORE;</span>
            }

<span class="nc bnc" id="L1836" title="All 2 branches missed.">            for (int pageNumber = 1; pageNumber &lt;= 5; pageNumber++) {</span>
<span class="nc" id="L1837">                int fromIndex = (pageNumber - 1) * cbServerProperties.getDiscussionEsDefaultPageSize();</span>
<span class="nc bnc" id="L1838" title="All 2 branches missed.">                if (fromIndex &gt;= discussions.size()) {</span>
<span class="nc" id="L1839">                    break;</span>
                }
<span class="nc" id="L1841">                int toIndex = Math.min(fromIndex + cbServerProperties.getDiscussionEsDefaultPageSize(), discussions.size());</span>
<span class="nc" id="L1842">                List&lt;Map&lt;String, Object&gt;&gt; pageDiscussions = new ArrayList&lt;&gt;(discussions.subList(fromIndex, toIndex));</span>

<span class="nc" id="L1844">                String cacheKey = cacheKeyPrefix + (pageNumber - 1);</span>
<span class="nc" id="L1845">                SearchResult pageResult = new SearchResult();</span>
<span class="nc" id="L1846">                pageResult.setData(pageDiscussions);</span>
<span class="nc" id="L1847">                pageResult.setTotalCount(searchResult.getTotalCount());</span>
<span class="nc" id="L1848">                pageResult.setFacets(searchResult.getFacets());</span>
<span class="nc" id="L1849">                redisTemplate.opsForValue().set(cacheKey, pageResult, cbServerProperties.getDiscussionFeedRedisTtl(), TimeUnit.SECONDS);</span>
            }
<span class="fc" id="L1851">        } catch (Exception e) {</span>
<span class="fc" id="L1852">            log.error(&quot;Error while updating cache for community {}: {}&quot;, communityId, e.getMessage(), e);</span>
<span class="nc" id="L1853">        }</span>
<span class="fc" id="L1854">    }</span>

    private String getFormattedCurrentTime(Timestamp currentTime) {
<span class="fc" id="L1857">        ZonedDateTime zonedDateTime = currentTime.toInstant().atZone(ZoneId.systemDefault());</span>
<span class="fc" id="L1858">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(Constants.TIME_FORMAT);</span>
<span class="fc" id="L1859">        return zonedDateTime.format(formatter);</span>
    }

    private String generateRedisTokenKey(SearchCriteria searchCriteria) {
<span class="pc bpc" id="L1863" title="1 of 2 branches missed.">        if (searchCriteria != null) {</span>

            try {
<span class="pc bpc" id="L1866" title="1 of 2 branches missed.">                if (searchCriteria.getFilterCriteriaMap() != null</span>
<span class="fc bfc" id="L1867" title="All 2 branches covered.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().size() == cbServerProperties.getUserFeedFilterCriteriaMapSize()</span>
<span class="pc bpc" id="L1868" title="1 of 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.CREATED_BY)</span>
<span class="nc bnc" id="L1869" title="All 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().get(Constants.CREATED_BY) instanceof String</span>
<span class="nc bnc" id="L1870" title="All 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.COMMUNITY_ID)</span>
<span class="nc bnc" id="L1871" title="All 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) instanceof String) {</span>

<span class="nc" id="L1873">                    SearchCriteria tempSearchCriteria = objectMapper.readValue(cbServerProperties.getFilterCriteriaQuestionUserFeed(), SearchCriteria.class);</span>
<span class="nc bnc" id="L1874" title="All 4 branches missed.">                    if (tempSearchCriteria != null &amp;&amp; tempSearchCriteria.getFilterCriteriaMap() != null) {</span>
<span class="nc" id="L1875">                        tempSearchCriteria.getFilterCriteriaMap().put(Constants.COMMUNITY_ID, searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID));</span>
<span class="nc" id="L1876">                        tempSearchCriteria.getFilterCriteriaMap().put(Constants.CREATED_BY, searchCriteria.getFilterCriteriaMap().get(Constants.CREATED_BY));</span>
<span class="nc" id="L1877">                        tempSearchCriteria.setPageNumber(searchCriteria.getPageNumber());</span>

<span class="nc bnc" id="L1879" title="All 2 branches missed.">                        if (tempSearchCriteria.equals(searchCriteria)) {</span>
<span class="nc" id="L1880">                            return Constants.DISCUSSION_POSTS_BY_USER</span>
<span class="nc" id="L1881">                                    + searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID)</span>
                                    + Constants.UNDER_SCORE
<span class="nc" id="L1883">                                    + searchCriteria.getFilterCriteriaMap().get(Constants.CREATED_BY)</span>
                                    + Constants.UNDER_SCORE
<span class="nc" id="L1885">                                    + searchCriteria.getPageNumber();</span>
                        }
                    }
                }
<span class="pc bpc" id="L1889" title="1 of 2 branches missed.">                if (searchCriteria.getFilterCriteriaMap() != null</span>
<span class="fc bfc" id="L1890" title="All 2 branches covered.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.COMMUNITY_ID)</span>
<span class="fc bfc" id="L1891" title="All 2 branches covered.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) instanceof String</span>
<span class="pc bpc" id="L1892" title="1 of 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.CATEGORY_TYPE)) {</span>
<span class="fc" id="L1893">                    SearchCriteria tempSearchCriteria = objectMapper.readValue(cbServerProperties.getFilterCriteriaQuestionDocumentFeed(), SearchCriteria.class);</span>
<span class="pc bpc" id="L1894" title="3 of 4 branches missed.">                    if (tempSearchCriteria != null &amp;&amp; tempSearchCriteria.getFilterCriteriaMap() != null) {</span>
<span class="nc" id="L1895">                        tempSearchCriteria.getFilterCriteriaMap().put(Constants.COMMUNITY_ID, searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID));</span>
<span class="nc" id="L1896">                        tempSearchCriteria.setPageNumber(searchCriteria.getPageNumber());</span>

<span class="nc bnc" id="L1898" title="All 2 branches missed.">                        if (tempSearchCriteria.equals(searchCriteria)) {</span>
<span class="nc" id="L1899">                            return Constants.DISCUSSION_DOCUMENT_POST + searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID)</span>
                                    + Constants.UNDER_SCORE
<span class="nc" id="L1901">                                    + searchCriteria.getPageNumber();</span>
                        }
                    }
                }

<span class="pc bpc" id="L1906" title="1 of 2 branches missed.">                if (searchCriteria.getFilterCriteriaMap() != null</span>
<span class="fc bfc" id="L1907" title="All 2 branches covered.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.COMMUNITY_ID)</span>
<span class="fc bfc" id="L1908" title="All 2 branches covered.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) instanceof String</span>
<span class="pc bpc" id="L1909" title="1 of 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().get(Constants.STATUS) instanceof List) {</span>
<span class="nc" id="L1910">                    SearchCriteria tempSearchCriteria = objectMapper.readValue(cbServerProperties.getMdoAllReportFeed(), SearchCriteria.class);</span>
<span class="nc bnc" id="L1911" title="All 4 branches missed.">                    if (tempSearchCriteria != null &amp;&amp; tempSearchCriteria.getFilterCriteriaMap() != null) {</span>
<span class="nc" id="L1912">                        tempSearchCriteria.getFilterCriteriaMap().put(Constants.COMMUNITY_ID, searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID));</span>
<span class="nc" id="L1913">                        tempSearchCriteria.setPageNumber(searchCriteria.getPageNumber());</span>

<span class="nc bnc" id="L1915" title="All 2 branches missed.">                        if (tempSearchCriteria.equals(searchCriteria)) {</span>
<span class="nc" id="L1916">                            return Constants.ALL_REPORTED_POSTS_CACHE_PREFIX + searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) + Constants.UNDER_SCORE + searchCriteria.getPageNumber();</span>
                        }
                    }
                }

<span class="pc bpc" id="L1921" title="1 of 2 branches missed.">                if (searchCriteria.getFilterCriteriaMap() != null</span>
<span class="pc bpc" id="L1922" title="1 of 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.STATUS)</span>
<span class="nc bnc" id="L1923" title="All 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.COMMUNITY_ID)</span>
<span class="nc bnc" id="L1924" title="All 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) instanceof String) {</span>

<span class="nc" id="L1926">                    SearchCriteria tempSearchCriteria = objectMapper.readValue(cbServerProperties.getMdoQuestionReportFeed(), SearchCriteria.class);</span>
<span class="nc bnc" id="L1927" title="All 4 branches missed.">                    if (tempSearchCriteria != null &amp;&amp; tempSearchCriteria.getFilterCriteriaMap() != null) {</span>
<span class="nc" id="L1928">                        tempSearchCriteria.getFilterCriteriaMap().put(Constants.COMMUNITY_ID, searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID));</span>
<span class="nc" id="L1929">                        tempSearchCriteria.setPageNumber(searchCriteria.getPageNumber());</span>

<span class="nc bnc" id="L1931" title="All 2 branches missed.">                        if (tempSearchCriteria.equals(searchCriteria)) {</span>
<span class="nc" id="L1932">                            return Constants.REPORTED_QUESTION_POSTS_CACHE_PREFIX + searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) + Constants.UNDER_SCORE + searchCriteria.getPageNumber();</span>
                        }
                    }
                }

<span class="pc bpc" id="L1937" title="1 of 2 branches missed.">                if (searchCriteria.getFilterCriteriaMap() != null</span>
<span class="pc bpc" id="L1938" title="1 of 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.STATUS)</span>
<span class="nc bnc" id="L1939" title="All 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.COMMUNITY_ID)</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) instanceof String) {</span>
<span class="nc" id="L1941">                    SearchCriteria tempSearchCriteria = objectMapper.readValue(cbServerProperties.getMdoAnswerPostReportFeed(), SearchCriteria.class);</span>
<span class="nc bnc" id="L1942" title="All 4 branches missed.">                    if (tempSearchCriteria != null &amp;&amp; tempSearchCriteria.getFilterCriteriaMap() != null) {</span>
<span class="nc" id="L1943">                        tempSearchCriteria.getFilterCriteriaMap().put(Constants.COMMUNITY_ID, searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID));</span>
<span class="nc" id="L1944">                        tempSearchCriteria.setPageNumber(searchCriteria.getPageNumber());</span>

<span class="nc bnc" id="L1946" title="All 2 branches missed.">                        if (tempSearchCriteria.equals(searchCriteria)) {</span>
<span class="nc" id="L1947">                            return Constants.REPORTED_ANSWER_POST_POSTS_CACHE_PREFIX + searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) + Constants.UNDER_SCORE + searchCriteria.getPageNumber();</span>
                        }
                    }
                }

<span class="pc bpc" id="L1952" title="1 of 2 branches missed.">                if (searchCriteria.getFilterCriteriaMap() != null</span>
<span class="pc bpc" id="L1953" title="1 of 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.STATUS)</span>
<span class="nc bnc" id="L1954" title="All 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.COMMUNITY_ID)</span>
<span class="nc bnc" id="L1955" title="All 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) instanceof String) {</span>

<span class="nc" id="L1957">                    SearchCriteria tempSearchCriteria = objectMapper.readValue(cbServerProperties.getMdoAnswerPostReplyReportFeed(), SearchCriteria.class);</span>
<span class="nc bnc" id="L1958" title="All 4 branches missed.">                    if (tempSearchCriteria != null &amp;&amp; tempSearchCriteria.getFilterCriteriaMap() != null) {</span>
<span class="nc" id="L1959">                        tempSearchCriteria.getFilterCriteriaMap().put(Constants.COMMUNITY_ID, searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID));</span>
<span class="nc" id="L1960">                        tempSearchCriteria.setPageNumber(searchCriteria.getPageNumber());</span>

<span class="nc bnc" id="L1962" title="All 2 branches missed.">                        if (tempSearchCriteria.equals(searchCriteria)) {</span>
<span class="nc" id="L1963">                            return Constants.REPORTED_ANSWER_POST_REPLY_POSTS_CACHE_PREFIX + searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) + Constants.UNDER_SCORE + searchCriteria.getPageNumber();</span>
                        }
                    }
                }

<span class="pc bpc" id="L1968" title="1 of 2 branches missed.">                if (searchCriteria.getFilterCriteriaMap() != null</span>
<span class="pc bpc" id="L1969" title="1 of 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.STATUS)</span>
<span class="nc bnc" id="L1970" title="All 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().containsKey(Constants.COMMUNITY_ID)</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">                        &amp;&amp; searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) instanceof String) {</span>

<span class="nc" id="L1973">                    SearchCriteria tempSearchCriteria = objectMapper.readValue(cbServerProperties.getMdoAllSuspendedFeed(), SearchCriteria.class);</span>
<span class="nc bnc" id="L1974" title="All 4 branches missed.">                    if (tempSearchCriteria != null &amp;&amp; tempSearchCriteria.getFilterCriteriaMap() != null) {</span>
<span class="nc" id="L1975">                        tempSearchCriteria.getFilterCriteriaMap().put(Constants.COMMUNITY_ID, searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID));</span>
<span class="nc" id="L1976">                        tempSearchCriteria.setPageNumber(searchCriteria.getPageNumber());</span>

<span class="nc bnc" id="L1978" title="All 2 branches missed.">                        if (tempSearchCriteria.equals(searchCriteria)) {</span>
<span class="nc" id="L1979">                            return Constants.SUSPENDED_POSTS_CACHE_PREFIX + searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID) + Constants.UNDER_SCORE + searchCriteria.getPageNumber();</span>
                        }
                    }
                }

<span class="fc" id="L1984">                String reqJsonString = objectMapper.writeValueAsString(searchCriteria);</span>
<span class="fc" id="L1985">                return JWT.create().withClaim(Constants.REQUEST_PAYLOAD, reqJsonString).sign(Algorithm.HMAC256(Constants.JWT_SECRET_KEY));</span>
<span class="nc" id="L1986">            } catch (JsonProcessingException e) {</span>
<span class="nc" id="L1987">                log.error(&quot;Error occurred while converting json object to json string&quot;, e);</span>
            }
        }
<span class="nc" id="L1990">        return &quot;&quot;;</span>
    }

    @Override
    public ApiResponse getEnrichedDiscussionData(Map&lt;String, Object&gt; data, String token) {
<span class="fc" id="L1995">        ApiResponse response = ProjectUtil.createDefaultResponse(&quot;discussion.getEnrichedDiscussionData&quot;);</span>
<span class="fc" id="L1996">        Map&lt;String, Object&gt; requestData = (Map&lt;String, Object&gt;) data.get(&quot;request&quot;);</span>

<span class="fc" id="L1998">        String userId = accessTokenValidator.verifyUserToken(token);</span>
<span class="pc bpc" id="L1999" title="1 of 4 branches missed.">        if (StringUtils.isBlank(userId) || userId.equals(Constants.UNAUTHORIZED)) {</span>
<span class="fc" id="L2000">            response.getParams().setErrMsg(Constants.INVALID_AUTH_TOKEN);</span>
<span class="fc" id="L2001">            response.setResponseCode(HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L2002">            return response;</span>
        }

<span class="fc" id="L2005">        String errMsg = validateEnrichDataRequest(requestData);</span>
<span class="fc bfc" id="L2006" title="All 2 branches covered.">        if (StringUtils.isNotBlank(errMsg)) {</span>
<span class="fc" id="L2007">            return ProjectUtil.returnErrorMsg(errMsg, HttpStatus.BAD_REQUEST, response, Constants.FAILED);</span>
        }

<span class="fc" id="L2010">        List&lt;Map&lt;String, Object&gt;&gt; communityFilters = (List&lt;Map&lt;String, Object&gt;&gt;) requestData.get(Constants.COMMUNITY_FILTERS);</span>
<span class="fc" id="L2011">        List&lt;String&gt; filters = (List&lt;String&gt;) requestData.get(Constants.FILTERS);</span>

<span class="fc" id="L2013">        List&lt;String&gt; allDiscussionIds = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L2014" title="All 2 branches covered.">        for (Map&lt;String, Object&gt; communityFilter : communityFilters) {</span>
<span class="fc" id="L2015">            List&lt;String&gt; discussionIdsForCommunity = (List&lt;String&gt;) communityFilter.get(&quot;identifier&quot;);</span>
<span class="fc" id="L2016">            allDiscussionIds.addAll(discussionIdsForCommunity);</span>
<span class="fc" id="L2017">        }</span>

<span class="fc" id="L2019">        Map&lt;String, Boolean&gt; likesMap = initializeDefaultMap(allDiscussionIds, false);</span>
<span class="fc" id="L2020">        Map&lt;String, Boolean&gt; bookmarksMap = initializeDefaultMap(allDiscussionIds, false);</span>
<span class="fc" id="L2021">        Map&lt;String, Boolean&gt; reportedMap = initializeDefaultMap(allDiscussionIds, false);</span>

        try {
<span class="fc bfc" id="L2024" title="All 2 branches covered.">            for (Map&lt;String, Object&gt; communityFilter : communityFilters) {</span>
<span class="fc" id="L2025">                String communityId = (String) communityFilter.get(Constants.COMMUNITY_ID);</span>
<span class="fc" id="L2026">                List&lt;String&gt; discussionIds = (List&lt;String&gt;) communityFilter.get(Constants.IDENTIFIER);</span>

<span class="fc bfc" id="L2028" title="All 2 branches covered.">                if (filters.contains(Constants.LIKES)) {</span>
<span class="fc" id="L2029">                    fetchLikes(discussionIds, userId, likesMap);</span>
                }
<span class="fc bfc" id="L2031" title="All 2 branches covered.">                if (filters.contains(Constants.BOOKMARKS)) {</span>
<span class="fc" id="L2032">                    fetchBookmarks(discussionIds, userId, communityId, bookmarksMap);</span>
                }
<span class="fc bfc" id="L2034" title="All 2 branches covered.">                if (filters.contains(Constants.REPORTED)) {</span>
<span class="fc" id="L2035">                    fetchReported(discussionIds, userId, reportedMap);</span>
                }
<span class="fc" id="L2037">            }</span>

<span class="fc" id="L2039">            Map&lt;String, Object&gt; searchResults = new HashMap&lt;&gt;();</span>
<span class="fc" id="L2040">            searchResults.put(Constants.LIKES, likesMap);</span>
<span class="fc" id="L2041">            searchResults.put(Constants.BOOKMARKS, bookmarksMap);</span>
<span class="fc" id="L2042">            searchResults.put(Constants.REPORTED, reportedMap);</span>
<span class="fc" id="L2043">            response.setResult(Collections.singletonMap(Constants.SEARCH_RESULTS, searchResults));</span>

<span class="fc" id="L2045">        } catch (Exception e) {</span>
<span class="fc" id="L2046">            log.error(&quot;DiscussionService::getEnrichedDiscussionData: Failed to fetch discussions&quot;, e);</span>
<span class="fc" id="L2047">            return ProjectUtil.returnErrorMsg(&quot;getEnrichedDiscussionData&quot;, HttpStatus.INTERNAL_SERVER_ERROR, response, Constants.FAILED);</span>
<span class="fc" id="L2048">        }</span>
<span class="fc" id="L2049">        return response;</span>
    }

    private Map&lt;String, Boolean&gt; initializeDefaultMap(List&lt;String&gt; discussionIds, boolean defaultValue) {
<span class="fc" id="L2053">        Map&lt;String, Boolean&gt; defaultMap = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L2054" title="All 2 branches covered.">        for (String discussionId : discussionIds) {</span>
<span class="fc" id="L2055">            defaultMap.put(discussionId, defaultValue);</span>
<span class="fc" id="L2056">        }</span>
<span class="fc" id="L2057">        return defaultMap;</span>
    }

    private void fetchLikes(List&lt;String&gt; discussionIds, String userId, Map&lt;String, Boolean&gt; likesMap) {
<span class="fc" id="L2061">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L2062">        properties.put(Constants.DISCUSSION_ID_KEY, discussionIds);</span>
<span class="fc" id="L2063">        properties.put(Constants.USERID, userId);</span>

<span class="fc" id="L2065">        List&lt;Map&lt;String, Object&gt;&gt; likesList = cassandraOperation.getRecordsByPropertiesWithoutFiltering(</span>
                Constants.KEYSPACE_SUNBIRD, Constants.USER_POST_VOTES, properties, null, null);

<span class="fc" id="L2068">        likesList.stream()</span>
<span class="pc" id="L2069">                .filter(record -&gt; Boolean.TRUE.equals(record.get(Constants.VOTE_TYPE)))</span>
<span class="pc" id="L2070">                .map(record -&gt; (String) record.get(Constants.DISCUSSION_ID_KEY))</span>
<span class="pc" id="L2071">                .forEach(discussionId -&gt; likesMap.put(discussionId, true));</span>
<span class="fc" id="L2072">    }</span>

    private void fetchBookmarks(List&lt;String&gt; discussionIds, String userId, String communityId, Map&lt;String, Boolean&gt; bookmarksMap) {

<span class="fc" id="L2076">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L2077">        properties.put(Constants.DISCUSSION_ID_KEY, discussionIds);</span>
<span class="fc" id="L2078">        properties.put(Constants.USERID, userId);</span>
<span class="fc" id="L2079">        properties.put(Constants.COMMUNITY_ID, communityId);</span>

<span class="fc" id="L2081">        List&lt;Map&lt;String, Object&gt;&gt; bookmarksList = cassandraOperation.getRecordsByPropertiesWithoutFiltering(</span>
                Constants.KEYSPACE_SUNBIRD, Constants.DISCUSSION_BOOKMARKS, properties, null, null);

<span class="fc" id="L2084">        bookmarksList.stream()</span>
<span class="pc" id="L2085">                .filter(record -&gt; Boolean.TRUE.equals(record.get(Constants.STATUS)))</span>
<span class="pc" id="L2086">                .map(record -&gt; (String) record.get(Constants.DISCUSSION_ID_KEY))</span>
<span class="pc" id="L2087">                .forEach(discussionId -&gt; bookmarksMap.put(discussionId, true));</span>
<span class="fc" id="L2088">    }</span>

    private void fetchReported(List&lt;String&gt; discussionIds, String userId, Map&lt;String, Boolean&gt; reportedMap) {
<span class="fc" id="L2091">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L2092">        properties.put(Constants.DISCUSSION_ID_KEY, discussionIds);</span>
<span class="fc" id="L2093">        properties.put(Constants.USERID, userId);</span>

<span class="fc" id="L2095">        List&lt;Map&lt;String, Object&gt;&gt; reportedList = cassandraOperation.getRecordsByPropertiesWithoutFiltering(</span>
                Constants.KEYSPACE_SUNBIRD, Constants.DISCUSSION_POST_REPORT_LOOKUP_BY_USER, properties, null, null);

<span class="fc" id="L2098">        reportedList.stream()</span>
<span class="pc" id="L2099">                .map(record -&gt; (String) record.get(Constants.DISCUSSION_ID_KEY))</span>
<span class="pc" id="L2100">                .forEach(discussionId -&gt; reportedMap.put(discussionId, true));</span>
<span class="fc" id="L2101">    }</span>

    private String validateEnrichDataRequest(Map&lt;String, Object&gt; requestData) {
<span class="pc bpc" id="L2104" title="1 of 2 branches missed.">        if (requestData == null) {</span>
<span class="nc" id="L2105">            return Constants.MISSING_REQUEST_DATA;</span>
        }

<span class="fc" id="L2108">        List&lt;String&gt; errList = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L2110">        Object communityFiltersObj = requestData.get(Constants.COMMUNITY_FILTERS);</span>
<span class="fc bfc" id="L2111" title="All 2 branches covered.">        if (!(communityFiltersObj instanceof List&lt;?&gt;)) {</span>
<span class="fc" id="L2112">            errList.add(&quot;Missing or invalid communityFilters.&quot;);</span>
        } else {
<span class="fc" id="L2114">            List&lt;?&gt; communityFilters = (List&lt;?&gt;) communityFiltersObj;</span>
<span class="pc bpc" id="L2115" title="1 of 2 branches missed.">            if (communityFilters.isEmpty()) {</span>
<span class="nc" id="L2116">                errList.add(&quot;Empty communityFilters.&quot;);</span>
            } else {
<span class="fc bfc" id="L2118" title="All 2 branches covered.">                for (Object obj : communityFilters) {</span>
<span class="pc bpc" id="L2119" title="1 of 2 branches missed.">                    if (!(obj instanceof Map&lt;?, ?&gt;)) {</span>
<span class="nc" id="L2120">                        errList.add(&quot;Invalid communityFilters structure.&quot;);</span>
<span class="nc" id="L2121">                        continue;</span>
                    }

<span class="fc" id="L2124">                    Map&lt;?, ?&gt; communityFilter = (Map&lt;?, ?&gt;) obj;</span>

<span class="fc" id="L2126">                    String communityId = (String) communityFilter.get(Constants.COMMUNITY_ID);</span>
<span class="fc" id="L2127">                    List&lt;?&gt; identifiers = (List&lt;?&gt;) communityFilter.get(Constants.IDENTIFIER);</span>

<span class="pc bpc" id="L2129" title="3 of 6 branches missed.">                    if (StringUtils.isBlank(communityId) || identifiers == null || identifiers.isEmpty()) {</span>
<span class="nc" id="L2130">                        errList.add(&quot;Invalid communityFilter: communityId or identifiers are missing/empty.&quot;);</span>
                    }
<span class="fc" id="L2132">                }</span>
            }
        }

<span class="fc" id="L2136">        List&lt;String&gt; validFilters = Arrays.asList(Constants.LIKES, Constants.BOOKMARKS, Constants.REPORTED);</span>
<span class="fc bfc" id="L2137" title="All 2 branches covered.">        if (!requestData.containsKey(Constants.FILTERS) ||</span>
<span class="pc bpc" id="L2138" title="1 of 2 branches missed.">                !(requestData.get(Constants.FILTERS) instanceof List)) {</span>
<span class="fc" id="L2139">            errList.add(Constants.FILTERS);</span>
        } else {
<span class="fc" id="L2141">            List&lt;?&gt; filtersList = (List&lt;?&gt;) requestData.get(Constants.FILTERS);</span>
<span class="pc bpc" id="L2142" title="2 of 4 branches missed.">            if (filtersList.isEmpty() || filtersList.stream().noneMatch(validFilters::contains)) {</span>
<span class="nc" id="L2143">                errList.add(Constants.FILTERS);</span>
            }
        }
<span class="fc bfc" id="L2146" title="All 2 branches covered.">        return errList.isEmpty() ? &quot;&quot; : &quot;Failed Due To Missing or Invalid Params - &quot; + errList + &quot;.&quot;;</span>
    }

    @Override
    public ApiResponse getGlobalFeed(SearchCriteria searchCriteria, String token, boolean isOverride) {
<span class="fc" id="L2151">        ApiResponse response = ProjectUtil.createDefaultResponse(Constants.DISCUSSION_GET_GLOBAL_FEED_API);</span>
<span class="fc" id="L2152">        String userId = accessTokenValidator.verifyUserToken(token);</span>

<span class="pc bpc" id="L2154" title="1 of 4 branches missed.">        if (StringUtils.isBlank(userId) || Constants.UNAUTHORIZED.equals(userId)) {</span>
<span class="fc" id="L2155">            return ProjectUtil.returnErrorMsg(Constants.INVALID_AUTH_TOKEN, HttpStatus.UNAUTHORIZED, response, Constants.FAILED);</span>
        }
<span class="fc" id="L2157">        return getGlobalFeedUsingUserId(searchCriteria, userId, isOverride);</span>
    }

    private ApiResponse getGlobalFeedUsingUserId(SearchCriteria searchCriteria, String userId, boolean isOverride) {
<span class="fc" id="L2161">        ApiResponse response = ProjectUtil.createDefaultResponse(Constants.DISCUSSION_GET_GLOBAL_FEED_API);</span>

<span class="pc bpc" id="L2163" title="2 of 4 branches missed.">        if (StringUtils.isBlank(userId) || Constants.UNAUTHORIZED.equals(userId)) {</span>
<span class="nc" id="L2164">            return ProjectUtil.returnErrorMsg(Constants.INVALID_AUTH_TOKEN, HttpStatus.UNAUTHORIZED, response, Constants.FAILED);</span>
        }

<span class="fc" id="L2167">        populateCommunityIds(userId, searchCriteria);</span>
<span class="fc bfc" id="L2168" title="All 2 branches covered.">        if (CollectionUtils.isEmpty((Set&lt;String&gt;) searchCriteria.getFilterCriteriaMap().get(Constants.COMMUNITY_ID))) {</span>
<span class="fc" id="L2169">            return ProjectUtil.returnErrorMsg(Constants.NO_COMMUNITY_FOUND, HttpStatus.OK, response, Constants.SUCCESS);</span>
        }
<span class="fc" id="L2171">        response = searchDiscussion(searchCriteria, isOverride);</span>
<span class="fc" id="L2172">        return response;</span>
    }

    private void populateCommunityIds(String userId, SearchCriteria searchCriteria) {
<span class="fc" id="L2176">        Map&lt;String, Object&gt; propertyMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L2177">        propertyMap.put(Constants.USERID, userId);</span>
<span class="fc" id="L2178">        List&lt;Map&lt;String, Object&gt;&gt; communitiesData = cassandraOperation.getRecordsByPropertiesWithoutFiltering(</span>
<span class="fc" id="L2179">                Constants.KEYSPACE_SUNBIRD, Constants.USER_COMMUNITY, propertyMap, Arrays.asList(Constants.COMMUNITY_ID_KEY, Constants.STATUS), null);</span>
<span class="fc bfc" id="L2180" title="All 2 branches covered.">        if (!CollectionUtils.isEmpty(communitiesData)) {</span>
<span class="fc" id="L2181">            Set&lt;String&gt; communityIds = communitiesData.stream()</span>
<span class="fc" id="L2182">                    .filter(community -&gt; (boolean) community.get(Constants.STATUS))</span>
<span class="fc" id="L2183">                    .map(community -&gt; (String) community.get(Constants.COMMUNITY_ID_KEY))</span>
<span class="fc" id="L2184">                    .collect(Collectors.toSet());</span>

<span class="pc bpc" id="L2186" title="1 of 2 branches missed.">            if (!CollectionUtils.isEmpty(communityIds)) {</span>
<span class="fc" id="L2187">                searchCriteria.getFilterCriteriaMap().put(Constants.COMMUNITY_ID, communityIds);</span>
            }
        }
<span class="fc" id="L2190">    }</span>

    private boolean isTrendingPost(SearchCriteria searchCriteria) {
        try {
<span class="fc" id="L2194">            SearchCriteria trendingCriteria = objectMapper.readValue(cbServerProperties.getFilterCriteriaTrendingFeed(), SearchCriteria.class);</span>
<span class="fc" id="L2195">            trendingCriteria.setPageNumber(searchCriteria.getPageNumber());</span>
<span class="fc" id="L2196">            return searchCriteria.equals(trendingCriteria);</span>
<span class="fc" id="L2197">        } catch (Exception e) {</span>
<span class="fc" id="L2198">            log.error(&quot;Error occurred while checking if the post is trending&quot;, e);</span>
<span class="fc" id="L2199">            return false;</span>
        }
    }

    private void enhanceCommunityData(List&lt;Map&lt;String, Object&gt;&gt; discussions) {
<span class="nc" id="L2204">        Set&lt;String&gt; communityIds = discussions.stream()</span>
<span class="nc" id="L2205">                .map(discussion -&gt; (String) discussion.get(Constants.COMMUNITY_ID))</span>
<span class="nc" id="L2206">                .collect(Collectors.toSet());</span>

        // Fetch community data from Redis
<span class="nc" id="L2209">        List&lt;Object&gt; redisResults = fetchDataForKeys(</span>
<span class="nc" id="L2210">                communityIds.stream().map(id -&gt; Constants.COMMUNITY_PREFIX + id).collect(Collectors.toList()), false</span>
        );

<span class="nc" id="L2213">        Map&lt;String, String&gt; communityDetailsMap = redisResults.stream()</span>
<span class="nc" id="L2214">                .map(community -&gt; (Map&lt;String, Object&gt;) community)</span>
<span class="nc" id="L2215">                .collect(Collectors.toMap(</span>
<span class="nc" id="L2216">                        community -&gt; community.get(Constants.COMMUNITY_ID).toString(),</span>
<span class="nc" id="L2217">                        community -&gt; (String) community.get(Constants.COMMUNITY_NAME)</span>
                ));

        // Identify missing communityIds
<span class="nc" id="L2221">        List&lt;String&gt; missingCommunityIds = communityIds.stream()</span>
<span class="nc bnc" id="L2222" title="All 2 branches missed.">                .filter(id -&gt; !communityDetailsMap.containsKey(id))</span>
<span class="nc" id="L2223">                .collect(Collectors.toList());</span>

        // Fetch missing community data from PostgreSQL
<span class="nc bnc" id="L2226" title="All 2 branches missed.">        if (!missingCommunityIds.isEmpty()) {</span>
<span class="nc" id="L2227">            List&lt;Object&gt; postgresResults = fetchCommunityFromPrimary(missingCommunityIds);</span>
<span class="nc bnc" id="L2228" title="All 2 branches missed.">            for (Object community : postgresResults) {</span>
<span class="nc" id="L2229">                Map&lt;String, Object&gt; communityMap = (Map&lt;String, Object&gt;) community;</span>
<span class="nc" id="L2230">                communityDetailsMap.put(</span>
<span class="nc" id="L2231">                        communityMap.get(Constants.COMMUNITY_ID_KEY).toString(),</span>
<span class="nc" id="L2232">                        (String) communityMap.get(Constants.COMMUNITY_NAME)</span>
                );
<span class="nc" id="L2234">            }</span>
        }

        // Enhance discussions with community data
<span class="nc" id="L2238">        discussions.forEach(discussion -&gt; {</span>
<span class="nc" id="L2239">            String communityId = (String) discussion.get(Constants.COMMUNITY_ID);</span>
<span class="nc bnc" id="L2240" title="All 2 branches missed.">            if (communityDetailsMap.containsKey(communityId)) {</span>
<span class="nc" id="L2241">                discussion.put(Constants.COMMUNITY_NAME, communityDetailsMap.get(communityId));</span>
            }
<span class="nc" id="L2243">        });</span>
<span class="nc" id="L2244">    }</span>

    private List&lt;Object&gt; fetchCommunityFromPrimary(List&lt;String&gt; communityIds) {
<span class="nc" id="L2247">        log.info(&quot;Fetching community data from PostgreSQL&quot;);</span>
<span class="nc" id="L2248">        List&lt;Object&gt; communityList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2249">        long startTime = System.currentTimeMillis();</span>

<span class="nc" id="L2251">        List&lt;CommunityEntity&gt; communityEntities = communityEngagementRepository.findAllById(communityIds);</span>
<span class="nc" id="L2252">        updateMetricsDbOperation(Constants.DISCUSSION_SEARCH, Constants.POSTGRES, Constants.READ, startTime);</span>

<span class="nc" id="L2254">        communityList = communityEntities.stream()</span>
<span class="nc" id="L2255">                .map(communityEntity -&gt; {</span>
<span class="nc" id="L2256">                    Map&lt;String, Object&gt; communityMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2257">                    communityMap.put(Constants.COMMUNITY_ID_KEY, communityEntity.getCommunityId());</span>
<span class="nc" id="L2258">                    communityMap.put(Constants.COMMUNITY_NAME, communityEntity.getData().get(Constants.COMMUNITY_NAME).asText());</span>
<span class="nc" id="L2259">                    return communityMap;</span>
                })
<span class="nc" id="L2261">                .collect(Collectors.toList());</span>
<span class="nc" id="L2262">        return communityList;</span>
    }

    private List&lt;String&gt; getTrendingPosts() {
<span class="fc" id="L2266">        SearchCriteria searchCriteria = new SearchCriteria();</span>
<span class="fc" id="L2267">        searchCriteria.setFilterCriteriaMap(new HashMap&lt;&gt;());</span>
<span class="fc" id="L2268">        searchCriteria.setRequestedFields(Arrays.asList(Constants.COMMUNITY_ID));</span>
<span class="fc" id="L2269">        searchCriteria.getFilterCriteriaMap().put(Constants.STATUS, Constants.ACTIVE);</span>
<span class="fc" id="L2270">        searchCriteria.getFilterCriteriaMap().put(IS_PROFANE, false);</span>
<span class="fc" id="L2271">        searchCriteria.setOrderBy(Constants.COUNT_OF_ANSWER_POST_COUNT);</span>
<span class="fc" id="L2272">        searchCriteria.setOrderDirection(Constants.DESC);</span>
<span class="fc" id="L2273">        searchCriteria.setPageNumber(0);</span>
<span class="fc" id="L2274">        searchCriteria.setPageSize(10);</span>
<span class="fc" id="L2275">        SearchResult result = null;</span>
<span class="fc" id="L2276">        List&lt;String&gt; communityIds = new ArrayList&lt;&gt;();</span>
        try {
<span class="fc" id="L2278">            result = esUtilService.searchDocuments(cbServerProperties.getCommunityEntity(), searchCriteria, cbServerProperties.getElasticCommunityJsonPath());</span>

<span class="pc bpc" id="L2280" title="1 of 2 branches missed.">            if (CollectionUtils.isNotEmpty(result.getData())) {</span>
<span class="fc" id="L2281">                List&lt;Map&lt;String, Object&gt;&gt; communities = result.getData();</span>
<span class="fc bfc" id="L2282" title="All 2 branches covered.">                for (Map&lt;String, Object&gt; community : communities) {</span>
<span class="fc" id="L2283">                    communityIds.add((String) community.get(Constants.COMMUNITY_ID));</span>
<span class="fc" id="L2284">                }</span>
            }
<span class="nc" id="L2286">        } catch (Exception e) {</span>
<span class="nc" id="L2287">            log.error(&quot;Error occurred while fetching trending communities&quot;, e);</span>
<span class="fc" id="L2288">        }</span>
<span class="fc" id="L2289">        return communityIds;</span>
    }

    private SearchCriteria createDefaultSearchCriteria(String parentAnswerPostId,
                                                       String communityId) {
<span class="fc" id="L2294">        SearchCriteria criteria = new SearchCriteria();</span>
<span class="fc" id="L2295">        HashMap&lt;String, Object&gt; filterMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L2296">        filterMap.put(Constants.COMMUNITY_ID, communityId);</span>
<span class="fc" id="L2297">        filterMap.put(Constants.TYPE, Constants.ANSWER_POST_REPLY);</span>
<span class="fc" id="L2298">        filterMap.put(Constants.PARENT_ANSWER_POST_ID, parentAnswerPostId);</span>
<span class="fc" id="L2299">        criteria.setFilterCriteriaMap(filterMap);</span>
<span class="fc" id="L2300">        criteria.setRequestedFields(Collections.emptyList());</span>
<span class="fc" id="L2301">        criteria.setPageNumber(0);</span>
<span class="fc" id="L2302">        criteria.setPageSize(10);</span>
<span class="fc" id="L2303">        criteria.setOrderBy(Constants.CREATED_ON);</span>
<span class="fc" id="L2304">        criteria.setOrderDirection(Constants.DESC);</span>
<span class="fc" id="L2305">        criteria.setFacets(Collections.emptyList());</span>
<span class="fc" id="L2306">        return criteria;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>